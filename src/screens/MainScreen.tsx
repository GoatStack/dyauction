import React, { useState, useEffect, useRef } from 'react';
import {
  View,
  ScrollView,
  StyleSheet,
  TouchableOpacity,
  Dimensions,
  RefreshControl,
  Alert,
  BackHandler,
  Image,
} from 'react-native';

import {
  Text,
  Card,
  IconButton,
  ActivityIndicator,
  FAB,
  Portal,
  Modal,
  TextInput,
  Button,
  Divider,
} from 'react-native-paper';
import { useSafeAreaInsets } from 'react-native-safe-area-context';
import { auctionAPI } from '../utils/database';
import { notificationManager, Notification } from '../utils/notificationManager';
import AsyncStorage from '@react-native-async-storage/async-storage';
import { normalizeImageUrl, formatAuctionImages } from '../utils/imageUtils';
import { useAuth } from '../contexts/AuthContext';

const { width, height } = Dimensions.get('window');

// Ïù¥ÎØ∏ÏßÄ URL Î≥ÄÌôò Ìï®Ïàò - Ïú†Ìã∏Î¶¨Ìã∞ Ìï®Ïàò ÏÇ¨Ïö©
const convertImageUrl = (imageUrl: any): string => {
  return normalizeImageUrl(imageUrl);
};

interface Auction {
  id: number;
  title: string;
  description: string;
  startingPrice: number;
  currentPrice: number;
  endTime: string;
  status: string;
  seller: {
    username: string;
  };
  bidCount: number;
  participantCount?: number;
  imageUrl?: string;
  images?: string[];
}



interface MainScreenProps {
  navigation: any;
}

export default function MainScreen({ navigation }: MainScreenProps) {
  const insets = useSafeAreaInsets();
  const [auctions, setAuctions] = useState<Auction[]>([]);
  const [endedAuctions, setEndedAuctions] = useState<Auction[]>([]);
  const [hotAuction, setHotAuction] = useState<Auction | null>(null);
  const [loading, setLoading] = useState(true);
  const [notifications, setNotifications] = useState<Notification[]>([]);
  const [unreadCount, setUnreadCount] = useState(0);
  const [refreshing, setRefreshing] = useState(false);
  const [bidModalVisible, setBidModalVisible] = useState(false);
  const [selectedAuction, setSelectedAuction] = useState<Auction | null>(null);

  // ÏïåÎ¶º Í¥ÄÎ†® Ìï®ÏàòÎì§ (Í∞úÏù∏ÌôîÎêú ÏïåÎ¶º Í¥ÄÎ¶¨)
  const loadUserNotifications = async () => {
    try {
      const userData = await AsyncStorage.getItem('user');
      if (userData) {
        const user = JSON.parse(userData);
        const userNotifications = notificationManager.getUserNotifications(user.id);
        setNotifications(userNotifications);
        setUnreadCount(notificationManager.getUserUnreadCount(user.id));
      }
    } catch (error) {
      console.error('ÏÇ¨Ïö©Ïûê ÏïåÎ¶º Î°úÎìú Ïã§Ìå®:', error);
    }
  };
  
  // ÏûÖÏ∞∞ Ìèº
  const [bidAmount, setBidAmount] = useState('');
  const [searchQuery, setSearchQuery] = useState('');

  // Ïä§ÌÅ¨Î°§ Ï∞∏Ï°∞
  const activeScrollRef = useRef<ScrollView>(null);
  const endedScrollRef = useRef<ScrollView>(null);

  // Í≤ΩÎß§ Î™©Î°ù Î°úÎìú
  const loadAuctions = async () => {
    try {
      setLoading(true);
      const [activeResponse, endedResponse, hotResponse] = await Promise.all([
        auctionAPI.getActiveAuctions(),
        auctionAPI.getEndedAuctions(),
        auctionAPI.getHotAuction()
      ]);
      
      // ÌôúÏÑ± Í≤ΩÎß§ Ï≤òÎ¶¨
      const processedActiveAuctions = (activeResponse || []).map((auction: any) => {
        let images: string[] = [];
        if (auction.images) {
          try {
            images = JSON.parse(auction.images);
          } catch (e) {
            console.log('Ïù¥ÎØ∏ÏßÄ ÌååÏã± Ïã§Ìå®, Îã®Ïùº Ïù¥ÎØ∏ÏßÄÎ°ú Ï≤òÎ¶¨');
            images = [auction.images];
          }
        }
        
        const result = {
          ...auction,
          images: images,
          imageUrl: images.length > 0 ? images[0] : auction.imageUrl,
          participantCount: auction.participantCount || 0
        };
        
        // ÎîîÎ≤ÑÍπÖ Î°úÍ∑∏ Ï†úÍ±∞
        
        return result;
      });
      
      // Ï¢ÖÎ£åÎêú Í≤ΩÎß§ Ï≤òÎ¶¨
      const processedEndedAuctions = (endedResponse || []).map((auction: any) => {
        let images: string[] = [];
        if (auction.images) {
          try {
            images = JSON.parse(auction.images);
          } catch (e) {
            console.log('Ïù¥ÎØ∏ÏßÄ ÌååÏã± Ïã§Ìå®, Îã®Ïùº Ïù¥ÎØ∏ÏßÄÎ°ú Ï≤òÎ¶¨');
            images = [auction.images];
          }
        }
        
        return {
          ...auction,
          images: images,
          imageUrl: images.length > 0 ? images[0] : auction.imageUrl,
          participantCount: auction.participantCount || 0
        };
      });
      
      // Ìï´Ìïú Í≤ΩÎß§ Ï≤òÎ¶¨
      let processedHotAuction = null;
      if (hotResponse) {
        console.log('üî• Ìï´Ìïú Í≤ΩÎß§ ÏõêÎ≥∏ Îç∞Ïù¥ÌÑ∞:', hotResponse);
        
        let images: string[] = [];
        if (hotResponse.images) {
          try {
            images = JSON.parse(hotResponse.images);
            console.log('üî• Ìï´Ìïú Í≤ΩÎß§ ÌååÏã±Îêú Ïù¥ÎØ∏ÏßÄ Î∞∞Ïó¥:', images);
          } catch (e) {
            console.log('üî• Ìï´Ìïú Í≤ΩÎß§ Ïù¥ÎØ∏ÏßÄ ÌååÏã± Ïã§Ìå®, Îã®Ïùº Ïù¥ÎØ∏ÏßÄÎ°ú Ï≤òÎ¶¨:', hotResponse.images);
            images = [hotResponse.images];
          }
        }
        
        const finalImageUrl = images.length > 0 ? images[0] : hotResponse.imageUrl;
        console.log('üî• Ìï´Ìïú Í≤ΩÎß§ ÏµúÏ¢Ö Ïù¥ÎØ∏ÏßÄ URL:', finalImageUrl);
        console.log('üî• Ìï´Ìïú Í≤ΩÎß§ convertImageUrl Í≤∞Í≥º:', convertImageUrl(finalImageUrl));
        
        processedHotAuction = {
          ...hotResponse,
          images: images,
          imageUrl: finalImageUrl,
          participantCount: hotResponse.participantCount || 0
        };
        
        console.log('üî• Ìï´Ìïú Í≤ΩÎß§ ÏµúÏ¢Ö Ï≤òÎ¶¨Îêú Îç∞Ïù¥ÌÑ∞:', processedHotAuction);
      }
      
      setAuctions(processedActiveAuctions);
      setEndedAuctions(processedEndedAuctions);
      setHotAuction(processedHotAuction);
    } catch (error: any) {
      console.error('Í≤ΩÎß§ Î™©Î°ù Î°úÎìú Ïã§Ìå®:', error);
      console.error('ÏóêÎü¨ ÏÉÅÏÑ∏ Ï†ïÎ≥¥:', {
        message: error?.message || 'Ïïå Ïàò ÏóÜÎäî Ïò§Î•ò',
        stack: error?.stack || 'Ïä§ÌÉù Ï†ïÎ≥¥ ÏóÜÏùå',
        name: error?.name || 'Error'
      });
      
      // Îçî Íµ¨Ï≤¥Ï†ÅÏù∏ ÏóêÎü¨ Î©îÏãúÏßÄ ÌëúÏãú
      let errorMessage = 'Í≤ΩÎß§ Î™©Î°ùÏùÑ Î∂àÎü¨Ïò¨ Ïàò ÏóÜÏäµÎãàÎã§.';
      if (error?.message?.includes('Í≤ΩÎß§Î•º Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§')) {
        errorMessage = 'ÌòÑÏû¨ Îì±Î°ùÎêú Í≤ΩÎß§Í∞Ä ÏóÜÏäµÎãàÎã§.';
      } else if (error?.message?.includes('ÏÑúÎ≤Ñ')) {
        errorMessage = 'ÏÑúÎ≤Ñ Ïó∞Í≤∞Ïóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.';
      } else if (error?.message?.includes('ÎÑ§Ìä∏ÏõåÌÅ¨')) {
        errorMessage = 'ÎÑ§Ìä∏ÏõåÌÅ¨ Ïó∞Í≤∞ÏùÑ ÌôïÏù∏Ìï¥Ï£ºÏÑ∏Ïöî.';
      }
      
      Alert.alert('Ïò§Î•ò', errorMessage);
    } finally {
      setLoading(false);
    }
  };



  // Í≤ÄÏÉâ Í∏∞Îä•
  const handleSearch = (query: string) => {
    setSearchQuery(query);
    // Ïã§Ï†ú Í≤ÄÏÉâ Î°úÏßÅÏùÄ ÎÇòÏ§ëÏóê Íµ¨ÌòÑ
    console.log('Í≤ÄÏÉâÏñ¥:', query);
  };

  // ÏÉàÎ°úÍ≥†Ïπ®
  const onRefresh = async () => {
    setRefreshing(true);
    await loadAuctions();
    setRefreshing(false);
  };

  // Ïª¥Ìè¨ÎÑåÌä∏ ÎßàÏö¥Ìä∏ Ïãú Í≤ΩÎß§ Î™©Î°ù Î°úÎìú
  useEffect(() => {
    loadAuctions();
    
    // ÏïåÎ¶º Îß§ÎãàÏ†Ä Î¶¨Ïä§ÎÑà Îì±Î°ù
    const unsubscribe = notificationManager.addListener((notifications) => {
      setNotifications(notifications);
      setUnreadCount(notificationManager.getUnreadCount());
    });
    
    // ÌÖåÏä§Ìä∏Ïö© ÏïåÎ¶º Ï∂îÍ∞Ä (Ïï± ÏãúÏûë Ïãú, Ìïú Î≤àÎßå)
    // AsyncStorageÏóêÏÑú Ïù¥ÎØ∏ Ï∂îÍ∞ÄÌñàÎäîÏßÄ ÌôïÏù∏
    const checkAndAddTestNotifications = async () => {
      try {
        const hasAddedTestNotifications = await AsyncStorage.getItem('hasAddedTestNotifications');
        
        if (!hasAddedTestNotifications && notifications.length === 0) {
          notificationManager.addNotification(
            'DY AuctionÏóê Ïò§Ïã† Í≤ÉÏùÑ ÌôòÏòÅÌï©ÎãàÎã§!',  // p0
            'Í≤ΩÎß§ Îì±Î°ù, ÏûÖÏ∞∞, ÏïåÎ¶º Îì± Îã§ÏñëÌïú Í∏∞Îä•ÏùÑ Ïù¥Ïö©Ìï¥Î≥¥ÏÑ∏Ïöî.',  // p1
            'info',  // p2
            {        // notification Í∞ùÏ≤¥
              title: 'DY AuctionÏóê Ïò§Ïã† Í≤ÉÏùÑ ÌôòÏòÅÌï©ÎãàÎã§!',
              message: 'Í≤ΩÎß§ Îì±Î°ù, ÏûÖÏ∞∞, ÏïåÎ¶º Îì± Îã§ÏñëÌïú Í∏∞Îä•ÏùÑ Ïù¥Ïö©Ìï¥Î≥¥ÏÑ∏Ïöî.',
            }
          );
          
          // Ï∂îÍ∞Ä ÌÖåÏä§Ìä∏ ÏïåÎ¶º
          setTimeout(() => {
            notificationManager.addNotification(
              'ÏÉàÎ°úÏö¥ Í≤ΩÎß§Í∞Ä Îì±Î°ùÎêòÏóàÏäµÎãàÎã§!',  // p0
              'Í¥ÄÏã¨ ÏûàÎäî ÏÉÅÌíàÏù¥ ÏûàÎã§Î©¥ ÏßÄÍ∏à ÌôïÏù∏Ìï¥Î≥¥ÏÑ∏Ïöî.',  // p1
              'success',  // p2
              {           // notification Í∞ùÏ≤¥
                title: 'ÏÉàÎ°úÏö¥ Í≤ΩÎß§Í∞Ä Îì±Î°ùÎêòÏóàÏäµÎãàÎã§!',
                message: 'Í¥ÄÏã¨ ÏûàÎäî ÏÉÅÌíàÏù¥ ÏûàÎã§Î©¥ ÏßÄÍ∏à ÌôïÏù∏Ìï¥Î≥¥ÏÑ∏Ïöî.',
              }
            );
          }, 1000);
          
          // ÌîåÎûòÍ∑∏ Ï†ÄÏû•
          await AsyncStorage.setItem('hasAddedTestNotifications', 'true');
        }
      } catch (error) {
        console.error('ÌÖåÏä§Ìä∏ ÏïåÎ¶º Ï∂îÍ∞Ä Ïã§Ìå®:', error);
      }
    };
    
    checkAndAddTestNotifications();
    
    // Í∞úÎ∞ú Ï§ëÏóêÎßå ÏÇ¨Ïö©: ÏïåÎ¶º Îç∞Ïù¥ÌÑ∞ Ï¥àÍ∏∞Ìôî (ÌïÑÏöîÏãú Ï£ºÏÑù Ìï¥Ï†ú)
    // AsyncStorage.removeItem('notifications');
    // AsyncStorage.removeItem('hasAddedTestNotifications');
    
    return unsubscribe;
  }, []);

  // Îí§Î°úÍ∞ÄÍ∏∞ Ï≤òÎ¶¨
  useEffect(() => {
    const backHandler = navigation.addListener('beforeRemove', (e: any) => {
      // Îí§Î°úÍ∞ÄÍ∏∞ ÏãúÎèÑ Ïãú Í∏∞Î≥∏ ÎèôÏûë Î∞©ÏßÄ
      e.preventDefault();
      
      // Ïù¥Ï†Ñ ÌôîÎ©¥ÏúºÎ°ú Ïù¥Îèô
      navigation.goBack();
    });

    return backHandler;
  }, [navigation]);



  // ÏûÖÏ∞∞
  const handleBid = async () => {
    if (!selectedAuction || !bidAmount.trim()) return;

    const amount = parseFloat(bidAmount);
    if (amount <= selectedAuction.currentPrice) {
      Alert.alert('Ïò§Î•ò', 'ÌòÑÏû¨ Í∞ÄÍ≤©Î≥¥Îã§ ÎÜíÏùÄ Í∏àÏï°ÏùÑ ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.');
      return;
    }

    try {
      await auctionAPI.createBid(selectedAuction.id.toString(), amount, 'YOUR_TOKEN_HERE'); // TODO: Ïã§Ï†ú ÌÜ†ÌÅ∞ ÏÇ¨Ïö©
      
      // ÏïåÎ¶º Ï∂îÍ∞Ä
      const userData = await AsyncStorage.getItem('user');
      if (userData) {
        const user = JSON.parse(userData);
        notificationManager.addBidPlacedNotification(user.id, selectedAuction.id, amount);
      }
      
      Alert.alert('ÏÑ±Í≥µ', 'ÏûÖÏ∞∞Ïù¥ ÏôÑÎ£åÎêòÏóàÏäµÎãàÎã§.');
      setBidModalVisible(false);
      setBidAmount('');
      setSelectedAuction(null);
      loadAuctions();
    } catch (error) {
      console.error('ÏûÖÏ∞∞ Ïã§Ìå®:', error);
      Alert.alert('Ïò§Î•ò', 'ÏûÖÏ∞∞Ïóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.');
    }
  };

  // Í≤ΩÎß§ ÏÉÅÌÉúÏóê Îî∞Î•∏ Ïπ© ÏÉâÏÉÅ
  const getStatusColor = (status: string) => {
    switch (status) {
      case 'active': return '#4CAF50';
      case 'ended': return '#F44336';
      case 'pending': return '#FF9800';
      default: return '#9E9E9E';
    }
  };

  // Í≤ΩÎß§ ÏÉÅÌÉú ÌÖçÏä§Ìä∏
  const getStatusText = (status: string) => {
    switch (status) {
      case 'active': return 'ÏßÑÌñâÏ§ë';
      case 'ended': return 'Ï¢ÖÎ£åÎê®';
      case 'pending': return 'ÎåÄÍ∏∞Ï§ë';
      default: return status;
    }
  };

  // ÎÇ®ÏùÄ ÏãúÍ∞Ñ Í≥ÑÏÇ∞
  const getTimeLeft = (endTime: string) => {
    const now = new Date();
    const end = new Date(endTime);
    const diff = end.getTime() - now.getTime();
    
    if (diff <= 0) return 'Ï¢ÖÎ£åÎê®';
    
    const days = Math.floor(diff / (1000 * 60 * 60 * 24));
    const hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
    const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
    
    if (days > 0) return `${days}Ïùº ${hours}ÏãúÍ∞Ñ`;
    if (hours > 0) return `${hours}ÏãúÍ∞Ñ ${minutes}Î∂Ñ`;
    return `${minutes}Î∂Ñ`;
  };

  // Ïä§ÌÅ¨Î°§ Ìï®Ïàò
  const scrollToDirection = (direction: 'left' | 'right', scrollRef: React.RefObject<ScrollView | null>) => {
    if (scrollRef.current) {
      const scrollAmount = 268; // Ïπ¥Îìú ÎÑàÎπÑ(220) + Ïó¨Î∞±(24) + Ï∂îÍ∞Ä Ïó¨Î∞±(24)
      scrollRef.current.scrollTo({
        x: direction === 'left' ? -scrollAmount : scrollAmount,
        animated: true,
      });
    }
  };

  // ÏÑπÏÖò Ìó§Îçî Î†åÎçîÎßÅ
  const renderSectionHeader = (title: string, scrollRef: React.RefObject<ScrollView | null> | null) => (
    <View style={styles.sectionHeader}>
      <Text style={styles.sectionTitle}>{title}</Text>
      {scrollRef && (
        <View style={styles.sectionActions}>
          <TouchableOpacity onPress={() => scrollToDirection('left', scrollRef)}>
            <IconButton icon="chevron-left" size={24} iconColor="#666" />
          </TouchableOpacity>
          <TouchableOpacity onPress={() => scrollToDirection('right', scrollRef)}>
            <IconButton icon="chevron-right" size={24} iconColor="#666" />
          </TouchableOpacity>
        </View>
      )}
        </View>
  );



  // Í≤ΩÎß§ ÏÉÅÏÑ∏ ÌéòÏù¥ÏßÄÎ°ú Ïù¥Îèô
  const handleAuctionPress = (auction: Auction) => {
    console.log('üîç Í≤ΩÎß§ ÌÅ¥Î¶≠:', {
      id: auction.id,
      title: auction.title,
      status: auction.status
    });
    
    // Î™®Îì† ÏÉÅÌÉúÏùò Í≤ΩÎß§Ïóê ÎåÄÌï¥ ÏÉÅÏÑ∏ ÌéòÏù¥ÏßÄÎ°ú Ïù¥Îèô Í∞ÄÎä•
    navigation.navigate('AuctionDetail', { auctionId: auction.id });
  };

  // ÏùºÎ∞ò Í≤ΩÎß§ ÏïÑÏù¥ÌÖú Î†åÎçîÎßÅ
  const renderAuctionItem = (item: Auction, isExpired = false) => (
    <TouchableOpacity 
      onPress={() => handleAuctionPress(item)}
      activeOpacity={0.7}
      key={item.id}
    >
      <Card style={styles.auctionItemCard}>
      <View style={styles.auctionItemImageContainer}>
        {isExpired ? (
          <View style={styles.expiredImageContainer}>
            <Card.Cover 
              source={{ uri: convertImageUrl(item.imageUrl) }} 
              style={styles.expiredImage} 
            />
            <View style={styles.expiredOverlay}>
              <Text style={styles.expiredImageText}>Ï¢ÖÎ£åÎê®</Text>
            </View>
          </View>
        ) : (
          <Card.Cover 
            source={{ uri: convertImageUrl(item.imageUrl) }} 
            style={styles.auctionItemImage} 
          />
        )}
        
        {/* Ïù¥ÎØ∏ÏßÄ Í∞úÏàò ÌëúÏãú */}
        {!isExpired && item.images && item.images.length > 1 && (
          <View style={styles.imageCountBadge}>
            <Text style={styles.imageCountText}>
              {item.images.length}
            </Text>
          </View>
        )}
        
        <View style={[styles.statusBadge, isExpired && styles.expiredBadge]}>
          <Text style={styles.statusBadgeText}>
            {isExpired ? 'Ï¢ÖÎ£å' : getStatusText(item.status)}
          </Text>
        </View>
      </View>
      <Card.Content style={styles.auctionItemContent}>
        <Text style={styles.auctionItemTitle} numberOfLines={1} ellipsizeMode="tail">
          {item.title}
        </Text>
        <View style={styles.auctionItemPriceContainer}>
          <Text style={styles.priceLabel}>ÌòÑÏû¨Í∞Ä</Text>
          <Text style={styles.auctionItemCurrentPrice}>
            ‚Ç©{item.currentPrice.toLocaleString()}
          </Text>
        </View>
        <View style={styles.auctionItemInfo}>
          <View style={styles.timeInfo}>
            <IconButton icon="clock-outline" size={14} iconColor="#666" />
            <Text style={[styles.auctionItemTimeLeft, isExpired && styles.expiredText]} numberOfLines={1} ellipsizeMode="tail">
              {isExpired ? 'Ï¢ÖÎ£åÎê®' : getTimeLeft(item.endTime)}
            </Text>
          </View>
          <View style={styles.participantInfo}>
            <IconButton icon="account-group-outline" size={14} iconColor="#666" />
            <Text style={styles.participantCount} numberOfLines={1} ellipsizeMode="tail">
              {item.participantCount || 0}Î™Ö
            </Text>
          </View>
        </View>
      </Card.Content>
    </Card>
      </TouchableOpacity>
  );

  if (loading) {
    return (
      <View style={styles.container}>
        <View style={styles.statusBarSpacer} />
        <View style={styles.loadingContainer}>
          <View style={styles.loadingIcon}>
            <IconButton icon="gavel" size={48} iconColor="#4A90E2" />
          </View>
          <ActivityIndicator size="large" color="#4A90E2" style={styles.loadingSpinner} />
          <Text style={styles.loadingText}>Í≤ΩÎß§ Î™©Î°ùÏùÑ Î∂àÎü¨Ïò§Îäî Ï§ë...</Text>
          <Text style={styles.loadingSubtext}>Ïû†ÏãúÎßå Í∏∞Îã§Î†§Ï£ºÏÑ∏Ïöî</Text>
      </View>
    </View>
  );
  }

  // ÏßÑÌñâÏ§ëÏù∏ Í≤ΩÎß§ÏôÄ Ï¢ÖÎ£åÎêú Í≤ΩÎß§ Î∂ÑÎ¶¨
  const activeAuctions = auctions.filter(auction => auction.status === 'active');

  return (
    <View style={styles.container}>
      {/* ÏÉÅÎã® Ïó¨Î∞± (ÏãúÏä§ÌÖú ÏÉÅÌÉúÎ∞î ÎåÄÏùë) */}
      <View style={styles.statusBarSpacer} />
      
      {/* Ìó§Îçî */}
      <View style={styles.header}>
        <View style={styles.headerLeft}>
          <Text style={styles.logoText}>DY Auction</Text>
    </View>
        
        <View style={styles.headerCenter}>
          <View style={styles.searchBar}>
            <IconButton icon="magnify" size={20} iconColor="#666" />
            <TextInput
              placeholder="Í≤ΩÎß§ Í≤ÄÏÉâ..."
              style={styles.searchInput}
              mode="flat"
              dense
              value={searchQuery}
              onChangeText={handleSearch}
            />
          </View>
        </View>

                <View style={styles.headerRight}>
          <TouchableOpacity 
            onPress={() => navigation.navigate('Notifications')}
            style={styles.notificationContainer}
          >
            <IconButton icon="bell-outline" size={20} iconColor="#000" />
            {unreadCount > 0 && (
          <View style={styles.notificationBadge}>
                <Text style={styles.notificationText}>
                  {unreadCount > 99 ? '99+' : unreadCount.toString()}
                </Text>
          </View>
        )}
      </TouchableOpacity>
    </View>
      </View>

      {/* Î©îÏù∏ ÏΩòÌÖêÏ∏† */}
      <ScrollView 
        style={styles.content} 
        showsVerticalScrollIndicator={false}
        refreshControl={
          <RefreshControl refreshing={refreshing} onRefresh={onRefresh} />
        }
      >
        {auctions.length === 0 ? (
          <View style={styles.emptyContainer}>
            <View style={styles.emptyIcon}>
              <IconButton icon="gavel" size={64} iconColor="#ccc" />
      </View>
            <Text style={styles.emptyTitle}>ÏïÑÏßÅ Îì±Î°ùÎêú Í≤ΩÎß§Í∞Ä ÏóÜÏäµÎãàÎã§</Text>
            <Text style={styles.emptySubtitle}>
              Í¥ÄÎ¶¨ÏûêÍ∞Ä Í≤ΩÎß§Î•º Îì±Î°ùÌïòÎ©¥ Ïó¨Í∏∞Ïóê ÌëúÏãúÎê©ÎãàÎã§
            </Text>
    </View>
        ) : (
          <>
        {/* Ìï´Ìïú Í≤ΩÎß§ */}
        {hotAuction && (
          <View style={styles.hotAuctionSection}>
            <View style={styles.hotAuctionHeader}>
              <Text style={styles.hotAuctionTitle}>üî• ÏßÄÍ∏à Í∞ÄÏû• Ïù∏Í∏∞ÏûàÎäî Í≤ΩÎß§</Text>
            </View>
            <TouchableOpacity
              style={styles.hotAuctionCard}
              onPress={() => handleAuctionPress(hotAuction)}
              activeOpacity={0.7}
            >
              <Image
                source={{ uri: convertImageUrl(hotAuction.imageUrl) }}
                style={styles.hotAuctionImage}
                resizeMode="cover"
              />
              
              {/* HOT Î∞∞ÏßÄ */}
              <View style={styles.hotBadge}>
                <Text style={styles.hotBadgeText}>üî• HOT</Text>
              </View>
              
              {/* ÌÉÄÏù¥Î®∏ Î∞∞ÏßÄ */}
              <View style={styles.timerBadge}>
                <Text style={styles.timerBadgeText}>üïí {getTimeLeft(hotAuction.endTime)}</Text>
          </View>
              
              <View style={styles.hotAuctionContent}>
                <Text style={styles.hotAuctionCardTitle} numberOfLines={2}>
                  {hotAuction.title}
                </Text>
                
                <View style={styles.hotAuctionParticipants}>
                  <Text style={styles.hotAuctionParticipantsText}>
                    üë• {hotAuction.participantCount || 0}Î™ÖÏù¥ ÏûÖÏ∞∞ Ï∞∏Ïó¨Ï§ë
                  </Text>
        </View>
                
                <View style={styles.hotAuctionPriceSection}>
                  <Text style={styles.hotAuctionPriceLabel}>ÌòÑÏû¨ ÏµúÍ≥†Í∞Ä</Text>
                  <Text style={styles.hotAuctionPrice}>‚Ç©{hotAuction.currentPrice.toLocaleString()}</Text>
                </View>
                
                <TouchableOpacity style={styles.bidNowButton}>
                  <Text style={styles.bidNowButtonText}>ÏßÄÍ∏à ÏûÖÏ∞∞ÌïòÍ∏∞</Text>
                </TouchableOpacity>
              </View>
            </TouchableOpacity>
          </View>
        )}

        {/* ÏßÑÌñâÏ§ëÏù∏ Í≤ΩÎß§ */}
        <View style={styles.section}>
              {renderSectionHeader('ÏßÑÌñâÏ§ëÏù∏ Í≤ΩÎß§', activeAuctions.length > 0 ? activeScrollRef : null)}
              {activeAuctions.length > 0 ? (
          <ScrollView
            ref={activeScrollRef}
            horizontal
            showsHorizontalScrollIndicator={false}
            contentContainerStyle={styles.horizontalScroll}
          >
            {activeAuctions.map((item) => renderAuctionItem(item))}
          </ScrollView>
              ) : (
                <View style={styles.emptyCardPlaceholder}>
                  <Text style={styles.emptyText}>ÏßÑÌñâÏ§ëÏù∏ Í≤ΩÎß§Í∞Ä ÏóÜÏäµÎãàÎã§</Text>
                </View>
              )}
        </View>

        {/* Ï¢ÖÎ£åÎêú Í≤ΩÎß§ */}
        <View style={styles.section}>
              {renderSectionHeader('Ï¢ÖÎ£åÎêú Í≤ΩÎß§', endedAuctions.length > 0 ? endedScrollRef : null)}
              {endedAuctions.length > 0 ? (
          <ScrollView
            ref={endedScrollRef}
            horizontal
            showsHorizontalScrollIndicator={false}
            contentContainerStyle={styles.horizontalScroll}
          >
                  {endedAuctions.map((item) => renderAuctionItem(item, true))}
        </ScrollView>
              ) : (
                <View style={styles.emptyCardPlaceholder}>
                  <Text style={styles.emptyText}>Ï¢ÖÎ£åÎêú Í≤ΩÎß§Í∞Ä ÏóÜÏäµÎãàÎã§</Text>
        </View>
              )}
            </View>
          </>
        )}
      </ScrollView>



      {/* Ïª§Ïä§ÌÖÄ ÌïòÎã® ÎÑ§ÎπÑÍ≤åÏù¥ÏÖò */}
      <View style={styles.bottomNavContainer}>
        <View style={[styles.bottomNav, { paddingBottom: insets.bottom }]}>
      <TouchableOpacity 
        style={styles.navItem}
            onPress={() => navigation.navigate('Home')}
      >
        <IconButton icon="home" size={24} iconColor="#333" />
        <Text style={styles.navText}>Ìôà</Text>
      </TouchableOpacity>
      
      <TouchableOpacity 
        style={styles.addButton}
        onPress={() => navigation.navigate('CreateAuction')}
      >
        <IconButton icon="plus" size={28} iconColor="white" />
      </TouchableOpacity>
      
      <TouchableOpacity 
        style={styles.navItem}
        onPress={() => navigation.navigate('Profile')}
      >
        <IconButton icon="account" size={24} iconColor="#666" />
        <Text style={styles.navText}>ÌîÑÎ°úÌïÑ</Text>
      </TouchableOpacity>
    </View>
      </View>



      {/* ÏûÖÏ∞∞ Î™®Îã¨ */}
      <Portal>
        <Modal
          visible={bidModalVisible}
          onDismiss={() => setBidModalVisible(false)}
          contentContainerStyle={styles.modal}
        >
          <Text style={styles.modalTitle}>ÏûÖÏ∞∞ÌïòÍ∏∞</Text>
          
          {selectedAuction && (
            <>
              <Text style={styles.bidAuctionTitle}>{selectedAuction.title}</Text>
              <Text style={styles.bidCurrentPrice}>
                ÌòÑÏû¨ Í∞ÄÍ≤©: ‚Ç©{selectedAuction.currentPrice.toLocaleString()}
              </Text>
              
              <Divider style={styles.divider} />
              
              <TextInput
                label="ÏûÖÏ∞∞ Í∏àÏï° (Ïõê)"
                value={bidAmount}
                onChangeText={setBidAmount}
                style={styles.modalInput}
                mode="outlined"
                keyboardType="numeric"
                placeholder={`${selectedAuction.currentPrice + 1000} Ïù¥ÏÉÅ`}
              />
            </>
          )}
          
          <View style={styles.modalActions}>
            <Button mode="outlined" onPress={() => setBidModalVisible(false)}>
              Ï∑®ÏÜå
            </Button>
            <Button mode="contained" onPress={handleBid}>
              ÏûÖÏ∞∞
            </Button>
          </View>
        </Modal>
      </Portal>


    </View>
  );
}

const styles = StyleSheet.create({
  container: {
    flex: 1,
    backgroundColor: '#f5f5f5',
  },
  statusBarSpacer: {
    height: 44, // iOS ÏÉÅÌÉúÎ∞î ÎÜíÏù¥
    backgroundColor: '#f5f5f5',
  },
  header: {
    backgroundColor: '#f5f5f5',
    paddingVertical: 16,
    paddingHorizontal: 12,
    flexDirection: 'row',
    alignItems: 'center',
    justifyContent: 'space-between',
  },
  headerLeft: {
    alignItems: 'center',
    marginRight: 8,
  },
  logoText: {
    fontSize: 18,
    fontWeight: 'bold',
    color: '#333',
  },
  headerCenter: {
    flex: 1,
    alignItems: 'center',
  },
  searchBar: {
    flexDirection: 'row',
    alignItems: 'center',
    backgroundColor: '#fff',
    borderRadius: 25,
    paddingHorizontal: 20,
    paddingVertical: 12,
    flex: 1,
    marginHorizontal: 8,
    shadowColor: '#000',
    shadowOffset: { width: 0, height: 2 },
    shadowOpacity: 0.1,
    shadowRadius: 4,
    elevation: 3,
  },
  searchInput: {
    flex: 1,
    backgroundColor: 'transparent',
    fontSize: 14,
    marginLeft: 8,
  },
  headerRight: {
    alignItems: 'center',
    marginLeft: 8,
  },
  notificationContainer: {
    position: 'relative',
  },
  notificationBadge: {
    position: 'absolute',
    top: -2,
    right: -2,
    backgroundColor: '#FF4757',
    borderRadius: 10,
    minWidth: 20,
    height: 20,
    alignItems: 'center',
    justifyContent: 'center',
    paddingHorizontal: 4,
  },
  notificationText: {
    color: '#fff',
    fontSize: 11,
    fontWeight: 'bold',
    textAlign: 'center',
  },
  content: {
    flex: 1,
    padding: 12,
    paddingTop: 16,
  },
  loadingContainer: {
    flex: 1,
    justifyContent: 'center',
    alignItems: 'center',
  },
  loadingText: {
    marginTop: 16,
    fontSize: 16,
    color: '#666',
  },
  emptyContainer: {
    flex: 1,
    justifyContent: 'center',
    alignItems: 'center',
    paddingVertical: 60,
  },
  emptyTitle: {
    fontSize: 20,
    fontWeight: 'bold',
    color: '#666',
    marginBottom: 8,
  },
  emptySubtitle: {
    fontSize: 16,
    color: '#999',
    marginBottom: 24,
    textAlign: 'center',
  },
  // Í∞úÏÑ†Îêú Îπà ÏÉÅÌÉú Ïä§ÌÉÄÏùº
  emptyIcon: {
    alignItems: 'center',
    marginBottom: 16,
  },
  // Í∞úÏÑ†Îêú Î°úÎî© ÏÉÅÌÉú Ïä§ÌÉÄÏùº
  loadingIcon: {
    alignItems: 'center',
    marginBottom: 16,
  },
  loadingSpinner: {
    marginBottom: 16,
  },
  loadingSubtext: {
    fontSize: 14,
    color: '#999',
    textAlign: 'center',
    marginTop: 8,
  },
  emptyCardPlaceholder: {
    width: 220,
    height: 180,
    backgroundColor: '#f8f9fa',
    borderRadius: 12,
    borderWidth: 2,
    borderColor: '#e9ecef',
    borderStyle: 'dashed',
    alignItems: 'center',
    justifyContent: 'center',
    marginRight: 24,
  },
  emptyText: {
    fontSize: 16,
    color: '#666',
    textAlign: 'center',
  },
  bottomNavContainer: {
    backgroundColor: '#f5f5f5',
  },
  bottomNav: {
    flexDirection: 'row',
    justifyContent: 'space-around',
    alignItems: 'center',
    paddingVertical: 0,
    backgroundColor: '#f5f5f5',
    borderTopWidth: 1,
    borderTopColor: '#e0e0e0',
  },
  navItem: {
    alignItems: 'center',
    flex: 1,
  },
  navText: {
    fontSize: 10,
    color: '#666',
    marginTop: 0,
  },
  addButton: {
    width: 50,
    height: 50,
    borderRadius: 25,
    backgroundColor: '#333',
    justifyContent: 'center',
    alignItems: 'center',
    elevation: 12,
    shadowColor: '#000',
    shadowOffset: { width: 0, height: 6 },
    shadowOpacity: 0.4,
    shadowRadius: 12,
    marginTop: 6,
  },
  section: {
    marginBottom: 24,
  },
  sectionHeader: {
    flexDirection: 'row',
    alignItems: 'center',
    marginBottom: 16,
  },
  sectionTitle: {
    fontSize: 16,
    fontWeight: '600',
    color: '#2c3e50',
    flex: 1,
  },
  sectionActions: {
    flexDirection: 'row',
    alignItems: 'center',
  },
  horizontalScroll: {
    paddingLeft: 0,
  },

  auctionItemCard: {
    width: 220,
    backgroundColor: 'white',
    borderRadius: 12,
    marginRight: 24,
    elevation: 0,
    shadowColor: 'transparent',
    shadowOffset: { width: 0, height: 0 },
    shadowOpacity: 0,
    shadowRadius: 0,
    minHeight: 180,
    borderWidth: 1,
    borderColor: '#e0e0e0',
  },
  auctionItemImageContainer: {
    position: 'relative',
  },
  auctionItemImage: {
    height: 140,
    borderTopLeftRadius: 12,
    borderTopRightRadius: 12,
  },
  expiredImageContainer: {
    height: 140,
    borderTopLeftRadius: 12,
    borderTopRightRadius: 12,
    position: 'relative',
  },
  expiredImage: {
    height: 140,
    borderTopLeftRadius: 12,
    borderTopRightRadius: 12,
    opacity: 0.3,
  },
  expiredOverlay: {
    position: 'absolute',
    top: 0,
    left: 0,
    right: 0,
    bottom: 0,
    backgroundColor: 'rgba(0, 0, 0, 0.5)',
    justifyContent: 'center',
    alignItems: 'center',
    borderTopLeftRadius: 12,
    borderTopRightRadius: 12,
  },
  expiredImageText: {
    color: 'white',
    fontSize: 16,
    fontWeight: 'bold',
    textShadowColor: 'rgba(0, 0, 0, 0.8)',
    textShadowOffset: { width: 1, height: 1 },
    textShadowRadius: 2,
  },
  statusBadge: {
    position: 'absolute',
    top: 10,
    left: 10,
    backgroundColor: '#4CAF50',
    paddingHorizontal: 8,
    paddingVertical: 4,
    borderRadius: 10,
  },
  imageCountBadge: {
    position: 'absolute',
    top: 10,
    right: 10,
    backgroundColor: 'rgba(0, 0, 0, 0.6)',
    paddingHorizontal: 8,
    paddingVertical: 4,
    borderRadius: 10,
    minWidth: 24,
    alignItems: 'center',
  },
  imageCountText: {
    color: '#fff',
    fontSize: 12,
    fontWeight: '600',
  },
  expiredBadge: {
    backgroundColor: '#6c757d',
  },
  statusBadgeText: {
    color: 'white',
    fontSize: 10,
    fontWeight: '600',
  },
  auctionItemContent: {
    padding: 12,
    paddingBottom: 16,
    flex: 1,
    justifyContent: 'space-between',
  },
  auctionItemTitle: {
    fontSize: 16,
    fontWeight: '600',
    color: '#2c3e50',
    marginBottom: 10,
    lineHeight: 20,
  },
  auctionItemPriceContainer: {
    marginBottom: 12,
    marginTop: 6,
  },
  priceLabel: {
    fontSize: 12,
    color: '#7f8c8d',
    marginBottom: 4,
  },
  auctionItemCurrentPrice: {
    fontSize: 16,
    fontWeight: '600',
    color: '#2c3e50',
    marginBottom: 8,
  },
  auctionItemInfo: {
    flexDirection: 'row',
    justifyContent: 'space-between',
    marginTop: 12,
    paddingTop: 0,
    paddingHorizontal: 4,
  },
  timeInfo: {
    flexDirection: 'row',
    alignItems: 'center',
    paddingLeft: 4,
  },
  participantInfo: {
    flexDirection: 'row',
    alignItems: 'center',
    paddingRight: 4,
  },
  auctionItemTimeLeft: {
    marginLeft: 6,
    color: '#7f8c8d',
    fontSize: 12,
    fontWeight: '500',
  },
  participantCount: {
    marginLeft: 6,
    color: '#7f8c8d',
    fontSize: 12,
    fontWeight: '500',
  },
  // Ìï´Ìïú Í≤ΩÎß§ Ïä§ÌÉÄÏùº
  hotAuctionSection: {
    margin: 16,
    marginBottom: 12,
  },
  hotAuctionHeader: {
    flexDirection: 'row',
    alignItems: 'center',
    marginBottom: 10,
  },
  hotAuctionTitle: {
    fontSize: 18,
    fontWeight: '700',
    color: '#FF6B35',
    marginLeft: 6,
  },
  hotAuctionCard: {
    borderRadius: 18,
    overflow: 'hidden',
    elevation: 10,
    shadowColor: '#FF6B35',
    shadowOffset: { width: 0, height: 6 },
    shadowOpacity: 0.3,
    shadowRadius: 12,
    backgroundColor: 'white',
    position: 'relative',
    marginHorizontal: 4,
  },
  hotAuctionImage: {
    width: '100%',
    height: 220,
  },
  hotBadge: {
    position: 'absolute',
    top: 12,
    left: 12,
    backgroundColor: '#FF6B35',
    paddingHorizontal: 10,
    paddingVertical: 5,
    borderRadius: 16,
    elevation: 3,
    shadowColor: '#000',
    shadowOffset: { width: 0, height: 2 },
    shadowOpacity: 0.2,
    shadowRadius: 3,
  },
  hotBadgeText: {
    color: 'white',
    fontSize: 11,
    fontWeight: '700',
  },
  timerBadge: {
    position: 'absolute',
    top: 12,
    right: 12,
    backgroundColor: 'rgba(0, 0, 0, 0.8)',
    paddingHorizontal: 10,
    paddingVertical: 5,
    borderRadius: 16,
    elevation: 3,
    shadowColor: '#000',
    shadowOffset: { width: 0, height: 2 },
    shadowOpacity: 0.2,
    shadowRadius: 3,
  },
  timerBadgeText: {
    color: 'white',
    fontSize: 11,
    fontWeight: '600',
  },
  hotAuctionContent: {
    padding: 16,
    backgroundColor: 'white',
  },
  hotAuctionCardTitle: {
    fontSize: 20,
    fontWeight: '700',
    color: '#2c3e50',
    marginBottom: 10,
    lineHeight: 24,
  },
  hotAuctionParticipants: {
    marginBottom: 16,
  },
  hotAuctionParticipantsText: {
    fontSize: 15,
    color: '#7f8c8d',
    fontWeight: '500',
  },
  hotAuctionPriceSection: {
    backgroundColor: '#FFF8F0',
    borderRadius: 14,
    padding: 16,
    marginBottom: 16,
    borderWidth: 1,
    borderColor: '#FFE4D6',
  },
  hotAuctionPriceLabel: {
    fontSize: 13,
    color: '#7f8c8d',
    marginBottom: 6,
    fontWeight: '500',
  },
  hotAuctionPrice: {
    fontSize: 28,
    fontWeight: '800',
    color: '#FF6B35',
    textAlign: 'center',
  },
  bidNowButton: {
    backgroundColor: '#FF6B35',
    borderRadius: 14,
    paddingVertical: 14,
    alignItems: 'center',
    elevation: 3,
    shadowColor: '#FF6B35',
    shadowOffset: { width: 0, height: 3 },
    shadowOpacity: 0.2,
    shadowRadius: 6,
  },
  bidNowButtonText: {
    color: 'white',
    fontSize: 16,
    fontWeight: '700',
  },
  expiredText: {
    color: '#999',
  },
  fab: {
    position: 'absolute',
    margin: 16,
    right: 0,
    bottom: 0,
  },
  modal: {
    backgroundColor: 'white',
    padding: 20,
    margin: 20,
    borderRadius: 8,
  },
  modalTitle: {
    fontSize: 20,
    fontWeight: 'bold',
    marginBottom: 20,
    textAlign: 'center',
  },
  modalInput: {
    marginBottom: 16,
  },
  modalActions: {
    flexDirection: 'row',
    justifyContent: 'space-between',
    marginTop: 20,
  },
  bidAuctionTitle: {
    fontSize: 16,
    fontWeight: 'bold',
    marginBottom: 8,
    textAlign: 'center',
  },
  bidCurrentPrice: {
    fontSize: 14,
    color: '#1976d2',
    marginBottom: 16,
    textAlign: 'center',
  },
  divider: {
    marginVertical: 16,
  },
});
