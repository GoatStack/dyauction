import express, { Request } from 'express';
import multer from 'multer';
import path from 'path';
import fs from 'fs';
import { getDatabase } from '../config/database';
import { auth, AuthRequest } from '../middleware/auth';
import { logAuctionActivity, getAuctionLogs } from '../utils/logger';
import { 
  sendWinNotificationEmail, 
  sendApprovalNotificationEmail, 
  sendHotAuctionNotificationEmail 
} from '../utils/emailService';
import { getImageUrl, processImageUrls, formatAuctionImages } from '../utils/imageUtils';

const router = express.Router();

// multer ÏÑ§Ï†ï (Ïù¥ÎØ∏ÏßÄ ÏóÖÎ°úÎìúÏö©)
const storage = multer.diskStorage({
  destination: (req, file, cb) => {
    const uploadDir = path.join(__dirname, '../../uploads');
    if (!fs.existsSync(uploadDir)) {
      fs.mkdirSync(uploadDir, { recursive: true });
    }
    cb(null, uploadDir);
  },
  filename: (req, file, cb) => {
    const uniqueSuffix = Date.now() + '_' + Math.round(Math.random() * 1E9);
    cb(null, uniqueSuffix + path.extname(file.originalname));
  }
});

const upload = multer({ 
  storage: storage,
  limits: {
    fileSize: 50 * 1024 * 1024, // 50MB Ï†úÌïú
    fieldSize: 50 * 1024 * 1024, // 50MB ÌïÑÎìú ÌÅ¨Í∏∞ Ï†úÌïú
    fieldNameSize: 100, // ÌïÑÎìúÎ™Ö ÌÅ¨Í∏∞ Ï†úÌïú
  },
  fileFilter: (req, file, cb) => {
    console.log('üîç ÌååÏùº ÌïÑÌÑ∞ Ï≤¥ÌÅ¨:', {
      fieldname: file.fieldname,
      originalname: file.originalname,
      mimetype: file.mimetype,
      size: file.size
    });
    
    if (file.mimetype.startsWith('image/')) {
      console.log('‚úÖ Ïù¥ÎØ∏ÏßÄ ÌååÏùº ÏäπÏù∏');
      cb(null, true);
    } else {
      console.log('‚ùå Ïù¥ÎØ∏ÏßÄ ÌååÏùºÏù¥ ÏïÑÎãò:', file.mimetype);
      cb(new Error('Ïù¥ÎØ∏ÏßÄ ÌååÏùºÎßå ÏóÖÎ°úÎìú Í∞ÄÎä•Ìï©ÎãàÎã§.'));
    }
  }
});

// ÏûêÎèô Í≤ΩÎß§ Ï¢ÖÎ£å Ìï®Ïàò
const autoEndExpiredAuctions = async () => {
  try {
    const db = getDatabase();
    const now = new Date().toISOString();
    
    // Ï¢ÖÎ£å ÏãúÍ∞ÑÏù¥ ÏßÄÎÇú ÌôúÏÑ± Í≤ΩÎß§ Ï°∞Ìöå
    const expiredAuctions = db.prepare(`
      SELECT a.*, u.email, u.username as seller_name
      FROM auctions a
      LEFT JOIN users u ON a.seller_id = u.id
      WHERE a.status = 'active' AND a.end_time <= ?
    `).all(now);
    
    console.log(`üïê ÏûêÎèô Ï¢ÖÎ£å Ï≤¥ÌÅ¨: ${expiredAuctions.length}Í∞ú Í≤ΩÎß§ Î∞úÍ≤¨`);
    
    for (const auction of expiredAuctions) {
      const auctionData = auction as any;
      
      // Í≤ΩÎß§ ÏÉÅÌÉúÎ•º Ï¢ÖÎ£åÎ°ú Î≥ÄÍ≤Ω
      db.prepare('UPDATE auctions SET status = ? WHERE id = ?').run('ended', auctionData.id);
      
      console.log(`‚úÖ Í≤ΩÎß§ ÏûêÎèô Ï¢ÖÎ£å: ${auctionData.title} (ID: ${auctionData.id})`);
      
      // ÎÇôÏ∞∞ÏûêÏôÄ ÌåêÎß§ÏûêÏóêÍ≤å ÏïåÎ¶º Ï†ÑÏÜ°
      if (auctionData.current_price > auctionData.starting_price) {
        try {
          // ÎÇôÏ∞∞Ïûê Ï†ïÎ≥¥ Ï°∞Ìöå
          const winnerInfo = db.prepare(`
            SELECT u.email, u.username 
            FROM users u 
            JOIN bids b ON u.id = b.bidder_id 
            WHERE b.auction_id = ? AND b.amount = ? 
            ORDER BY b.created_at DESC 
            LIMIT 1
          `).get(auctionData.id, auctionData.current_price) as any;
          
          // ÎÇôÏ∞∞ÏûêÏóêÍ≤å ÎÇôÏ∞∞ ÏïåÎ¶º
          if (winnerInfo?.email) {
            await sendWinNotificationEmail(
              winnerInfo.email,
              winnerInfo.username,
              auctionData.title,
              auctionData.current_price,
              auctionData.id
            );
            console.log(`üìß ÎÇôÏ∞∞ ÏïåÎ¶º Î∞úÏÜ°: ${winnerInfo.email} - ${auctionData.title}`);
          }
          
          // ÌåêÎß§ÏûêÏóêÍ≤å Í≤ΩÎß§ Ï¢ÖÎ£å ÏïåÎ¶º
          if (auctionData.email) {
            await sendApprovalNotificationEmail(
              auctionData.email,
              auctionData.seller_name,
              `${auctionData.title} Í≤ΩÎß§Í∞Ä Ï¢ÖÎ£åÎêòÏóàÏäµÎãàÎã§. ÎÇôÏ∞∞Í∞Ä: ${auctionData.current_price.toLocaleString()}Ïõê`,
              auctionData.id
            );
            console.log(`üìß Í≤ΩÎß§ Ï¢ÖÎ£å ÏïåÎ¶º Î∞úÏÜ°: ${auctionData.email} - ${auctionData.title}`);
          }
        } catch (error) {
          console.error('ÏûêÎèô Ï¢ÖÎ£å ÏïåÎ¶º Î∞úÏÜ° Ïã§Ìå®:', error);
        }
      } else {
        // ÏûÖÏ∞∞Ïù¥ ÏóÜÏóàÏùÑ ÎïåÎäî ÌåêÎß§ÏûêÏóêÍ≤åÎßå ÏïåÎ¶º
        if (auctionData.email) {
          try {
            await sendApprovalNotificationEmail(
              auctionData.email,
              auctionData.seller_name,
              `${auctionData.title} Í≤ΩÎß§Í∞Ä Ï¢ÖÎ£åÎêòÏóàÏäµÎãàÎã§. (ÏûÖÏ∞∞ ÏóÜÏùå)`,
              auctionData.id
            );
            console.log(`üìß Í≤ΩÎß§ Ï¢ÖÎ£å ÏïåÎ¶º Î∞úÏÜ°: ${auctionData.email} - ${auctionData.title} (ÏûÖÏ∞∞ ÏóÜÏùå)`);
          } catch (error) {
            console.error('ÏûêÎèô Ï¢ÖÎ£å ÏïåÎ¶º Î∞úÏÜ° Ïã§Ìå®:', error);
          }
        }
      }
    }
  } catch (error) {
    console.error('ÏûêÎèô Í≤ΩÎß§ Ï¢ÖÎ£å Ï≤òÎ¶¨ Ïã§Ìå®:', error);
  }
};

// 1Î∂ÑÎßàÎã§ ÏûêÎèô Ï¢ÖÎ£å Ï≤¥ÌÅ¨
setInterval(autoEndExpiredAuctions, 60000); // 60Ï¥à = 1Î∂Ñ

// Í≤ΩÎß§ Ïù¥ÎØ∏ÏßÄ ÏóÖÎ°úÎìú API (ÌååÏùº + DB Ï†ÄÏû• Î∞©Ïãù)
router.post('/upload-image', auth, upload.single('auctionImage'), async (req: AuthRequest, res) => {
  try {
    console.log('üì§ Ïù¥ÎØ∏ÏßÄ ÏóÖÎ°úÎìú ÏöîÏ≤≠ Î∞õÏùå:', {
      body: req.body,
      file: req.file ? {
        originalname: req.file.originalname,
        mimetype: req.file.mimetype,
        size: req.file.size
      } : null
    });
    
    if (!req.file) {
      console.log('‚ùå Ïù¥ÎØ∏ÏßÄ ÌååÏùºÏù¥ ÏóÜÏùå');
      return res.status(400).json({ message: 'Ïù¥ÎØ∏ÏßÄ ÌååÏùºÏù¥ ÌïÑÏöîÌï©ÎãàÎã§.' });
    }
    
    console.log('üìã ÏóÖÎ°úÎìúÎêú ÌååÏùº Ï†ïÎ≥¥:', {
      filename: req.file.filename,
      originalname: req.file.originalname,
      mimetype: req.file.mimetype,
      size: req.file.size,
      path: req.file.path
    });
    
    // ÌååÏùºÏùÑ ÏùΩÏñ¥ÏÑú DBÏóê Ï†ÄÏû•
    const fs = require('fs');
    const fileBuffer = fs.readFileSync(req.file.path);
    
    // Ïù¥ÎØ∏ÏßÄ ID ÏÉùÏÑ±
    const imageId = `img_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
    
    // DBÏóê Ïù¥ÎØ∏ÏßÄ Îç∞Ïù¥ÌÑ∞ Ï†ÄÏû•
    const db = getDatabase();
    const stmt = db.prepare(`
      INSERT INTO images (id, data, mime_type, size, created_at) 
      VALUES (?, ?, ?, ?, ?)
    `);
    
    const now = new Date().toISOString();
    stmt.run(imageId, fileBuffer, req.file.mimetype, req.file.size, now);
    
    console.log('üì§ Ïù¥ÎØ∏ÏßÄ DB Ï†ÄÏû• ÏÑ±Í≥µ:', {
      imageId: imageId,
      size: req.file.size,
      mimeType: req.file.mimetype,
      userId: req.user?.userId
    });
    
    const finalImageUrl = `/images/${imageId}`;
    console.log('üì§ Î∞òÌôòÌï† Ïù¥ÎØ∏ÏßÄ URL:', finalImageUrl);
    
    res.json({ 
      message: 'Ïù¥ÎØ∏ÏßÄ ÏóÖÎ°úÎìú ÏÑ±Í≥µ',
      imageId: imageId,
      imageUrl: finalImageUrl // DBÏóêÏÑú Ï°∞ÌöåÌïòÎäî URL (/api Ï†úÍ±∞)
    });
  } catch (error) {
    console.error('Ïù¥ÎØ∏ÏßÄ ÏóÖÎ°úÎìú Ïò§Î•ò:', error);
    res.status(500).json({ message: 'Ïù¥ÎØ∏ÏßÄ ÏóÖÎ°úÎìúÏóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.' });
  }
});

// OPTIONS ÏöîÏ≤≠ Ï≤òÎ¶¨ (CORS preflight)
router.options('/images/:imageId', (req, res) => {
  res.set({
    'Access-Control-Allow-Origin': '*',
    'Access-Control-Allow-Methods': 'GET, OPTIONS',
    'Access-Control-Allow-Headers': 'Content-Type, Authorization'
  });
  res.status(200).end();
});

// Ïù¥ÎØ∏ÏßÄ Ï°∞Ìöå API (DBÏóêÏÑú ÏßÅÏ†ë Ï°∞Ìöå)
router.get('/images/:imageId', async (req, res) => {
  try {
    const { imageId } = req.params;
    
    const db = getDatabase();
    const image = db.prepare(`
      SELECT data, mime_type FROM images WHERE id = ?
    `).get(imageId) as any;
    
    if (!image) {
      return res.status(404).json({ message: 'Ïù¥ÎØ∏ÏßÄÎ•º Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§.' });
    }
    
    res.set({
      'Content-Type': image.mime_type,
      'Cache-Control': 'public, max-age=31536000', // 1ÎÖÑ Ï∫êÏãú
      'Content-Length': image.data.length,
      'Access-Control-Allow-Origin': '*',
      'Access-Control-Allow-Methods': 'GET',
      'Access-Control-Allow-Headers': 'Content-Type'
    });
    
    res.send(image.data);
  } catch (error) {
    console.error('Ïù¥ÎØ∏ÏßÄ Ï°∞Ìöå Ïò§Î•ò:', error);
    res.status(500).json({ message: 'Ïù¥ÎØ∏ÏßÄ Ï°∞ÌöåÏóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.' });
  }
});

// Î™®Îì† ÌôúÏÑ± Í≤ΩÎß§ Ï°∞Ìöå
router.get('/', async (req, res) => {
  try {
    const db = getDatabase();
    const { type, userId } = req.query; // type: 'selling', 'bidding', 'all'
    
    let whereClause = "WHERE a.status = 'active'";
    let joinClause = "LEFT JOIN users u ON a.seller_id = u.id LEFT JOIN bids b ON a.id = b.auction_id";
    
    if (type === 'selling' && userId) {
      whereClause += ` AND a.seller_id = ${userId}`;
    } else if (type === 'bidding' && userId) {
      whereClause += ` AND a.id IN (SELECT DISTINCT auction_id FROM bids WHERE bidder_id = ${userId})`;
      joinClause = "LEFT JOIN users u ON a.seller_id = u.id INNER JOIN bids b ON a.id = b.auction_id";
    } else if (type === 'won' && userId) {
      whereClause = "WHERE a.status = 'ended' AND a.winner_id = " + userId;
    }
    
    let auctions;
    
    if (type === 'bidding' && userId) {
      // ÏûÖÏ∞∞Ìïú Í≤ΩÎß§Îäî ÏÑúÎ∏åÏøºÎ¶¨Î°ú Ï≤òÎ¶¨
      auctions = db.prepare(`
        SELECT 
          a.id,
          a.title,
          a.description,
          a.starting_price as startingPrice,
          a.current_price as currentPrice,
          a.end_time as endTime,
          a.status,
          a.created_at as createdAt,
          a.images,
          u.username as sellerName,
          (SELECT COUNT(*) FROM bids WHERE auction_id = a.id) as bidCount,
          (SELECT COUNT(DISTINCT bidder_id) FROM bids WHERE auction_id = a.id) as participantCount
        FROM auctions a
        LEFT JOIN users u ON a.seller_id = u.id
        WHERE a.status = 'active' AND a.id IN (SELECT DISTINCT auction_id FROM bids WHERE bidder_id = ?)
        ORDER BY a.created_at DESC
      `).all(userId);
    } else {
      // ÏùºÎ∞ò ÏøºÎ¶¨
      auctions = db.prepare(`
        SELECT 
          a.id,
          a.title,
          a.description,
          a.starting_price as startingPrice,
          a.current_price as currentPrice,
          a.end_time as endTime,
          a.status,
          a.created_at as createdAt,
          a.images,
          u.username as sellerName,
          COUNT(b.id) as bidCount,
          COUNT(DISTINCT b.bidder_id) as participantCount
        FROM auctions a
        ${joinClause}
        ${whereClause}
        GROUP BY a.id
        ORDER BY a.created_at DESC
      `).all();
    }
    
    // ÏùëÎãµ Îç∞Ïù¥ÌÑ∞ ÌòïÏãù ÎßûÏ∂îÍ∏∞ (Ïù¥ÎØ∏ÏßÄ URLÏùÄ Í∑∏ÎåÄÎ°ú ÏÇ¨Ïö©)
    const formattedAuctions = auctions.map((auction: any) => {
      
      return {
        id: auction.id,
        title: auction.title,
        description: auction.description,
        startingPrice: auction.startingPrice,
        currentPrice: auction.currentPrice,
        endTime: auction.endTime,
        status: auction.status,
        createdAt: auction.createdAt,
        images: auction.images ? JSON.parse(auction.images) : [],
        imageUrl: auction.images ? JSON.parse(auction.images)[0] : null,
        seller: {
          username: auction.sellerName
        },
        bidCount: auction.bidCount || 0,
        participantCount: auction.participantCount || 0
      };
    });
    
    res.json(formattedAuctions);
  } catch (error) {
    console.error('Get auctions error:', error);
    res.status(500).json({ message: 'Í≤ΩÎß§ Î™©Î°ùÏùÑ Î∂àÎü¨Ïò¨ Ïàò ÏóÜÏäµÎãàÎã§.' });
  }
});

// Ï¢ÖÎ£åÎêú Í≤ΩÎß§ Ï°∞Ìöå
router.get('/ended', async (req, res) => {
  try {
    const db = getDatabase();
    
    const auctions = db.prepare(`
      SELECT 
        a.id,
        a.title,
        a.description,
        a.starting_price as startingPrice,
        a.current_price as currentPrice,
        a.end_time as endTime,
        a.status,
        a.created_at as createdAt,
        a.images,
        u.username as sellerName,
        COUNT(b.id) as bidCount,
        COUNT(DISTINCT b.bidder_id) as participantCount
      FROM auctions a
      LEFT JOIN users u ON a.seller_id = u.id
      LEFT JOIN bids b ON a.id = b.auction_id
      WHERE a.status = 'ended'
      GROUP BY a.id
      ORDER BY a.end_time DESC
      LIMIT 20
    `).all();
    
    // ÏùëÎãµ Îç∞Ïù¥ÌÑ∞ ÌòïÏãù ÎßûÏ∂îÍ∏∞ Î∞è Ïù¥ÎØ∏ÏßÄ URL Î≥ÄÌôò
    const formattedAuctions = auctions.map((auction: any) => {
      let images = [];
      let imageUrl = null;
      
      if (auction.images) {
        try {
          images = JSON.parse(auction.images);

          imageUrl = images[0] || null;
        } catch (error) {
          console.error('Ïù¥ÎØ∏ÏßÄ ÌååÏã± Ïò§Î•ò:', error);
          images = [];
        }
      }
      
      return {
        id: auction.id,
        title: auction.title,
        description: auction.description,
        startingPrice: auction.startingPrice,
        currentPrice: auction.currentPrice,
        endTime: auction.endTime,
        status: auction.status,
        createdAt: auction.createdAt,
        images: images,
        imageUrl: imageUrl,
        seller: {
          username: auction.sellerName
        },
        bidCount: auction.bidCount || 0,
        participantCount: auction.participantCount || 0
      };
    });
    
    res.json(formattedAuctions);
  } catch (error) {
    console.error('Get ended auctions error:', error);
    res.status(500).json({ message: 'Ï¢ÖÎ£åÎêú Í≤ΩÎß§ Î™©Î°ùÏùÑ Î∂àÎü¨Ïò¨ Ïàò ÏóÜÏäµÎãàÎã§.' });
  }
});

// Ìï´Ìïú Í≤ΩÎß§ Ï°∞Ìöå
router.get('/hot', async (req, res) => {
  try {
    const db = getDatabase();
    
    const hotAuction = db.prepare(`
      SELECT 
        a.id,
        a.title,
        a.description,
        a.starting_price as startingPrice,
        a.current_price as currentPrice,
        a.end_time as endTime,
        a.status,
        a.created_at as createdAt,
        a.images,
        u.username as sellerName,
        COUNT(b.id) as bidCount,
        COUNT(DISTINCT b.bidder_id) as participantCount
      FROM auctions a
      LEFT JOIN users u ON a.seller_id = u.id
      LEFT JOIN bids b ON a.id = b.auction_id
      WHERE a.is_hot = 1 AND a.status = 'active'
      GROUP BY a.id
      LIMIT 1
    `).get() as any;
    
    if (!hotAuction) {
      return res.json(null);
    }
    
    // Ïù¥ÎØ∏ÏßÄ URLÏùÄ Í∑∏ÎåÄÎ°ú ÏÇ¨Ïö© (DBÏóêÏÑú Ï°∞ÌöåÌïú URL ÏÇ¨Ïö©)
    
    const result = {
      id: hotAuction.id,
      title: hotAuction.title,
      description: hotAuction.description,
      startingPrice: hotAuction.startingPrice,
      currentPrice: hotAuction.currentPrice,
      endTime: hotAuction.endTime,
      status: hotAuction.status,
      createdAt: hotAuction.createdAt,
      images: hotAuction.images ? JSON.parse(hotAuction.images) : [],
      imageUrl: hotAuction.images ? JSON.parse(hotAuction.images)[0] : null,
      seller: {
        username: hotAuction.sellerName
      },
      bidCount: hotAuction.bidCount || 0,
      participantCount: hotAuction.participantCount || 0
    };
    
    res.json(result);
  } catch (error) {
    console.error('Get hot auction error:', error);
    res.status(500).json({ message: 'ÏÑúÎ≤Ñ Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.' });
  }
});

// ÌäπÏ†ï Í≤ΩÎß§ Ï°∞Ìöå
router.get('/:id', async (req, res) => {
  try {
    const db = getDatabase();
    const auction = db.prepare(`
      SELECT a.*, u.username as seller_name 
      FROM auctions a 
      LEFT JOIN users u ON a.seller_id = u.id 
      WHERE a.id = ?
    `).get(req.params.id) as any;
    
    if (!auction) {
      return res.status(404).json({ message: 'Í≤ΩÎß§Î•º Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§.' });
    }
    
    // ÏûÖÏ∞∞ ÎÇ¥Ïó≠ Ï°∞Ìöå
    const bids = db.prepare(`
      SELECT b.*, u.username as bidder_name 
      FROM bids b 
      JOIN users u ON b.bidder_id = u.id 
      WHERE b.auction_id = ? 
      ORDER BY b.amount DESC
    `).all(req.params.id);
    
    // Ï∞∏Ïó¨Ïûê Ïàò Í≥ÑÏÇ∞ (Í≥†Ïú† bidder_id Í∞úÏàò)
    const participantCount = db.prepare(`
      SELECT COUNT(DISTINCT bidder_id) as count 
      FROM bids 
      WHERE auction_id = ?
    `).get(req.params.id) as any;
    
    auction.bids = bids;
    auction.participantCount = participantCount.count || 0;
    
    // Ïù¥ÎØ∏ÏßÄ Îç∞Ïù¥ÌÑ∞ ÌååÏã± (Ïù¥ÎØ∏ Ïõπ URLÏù¥ÎØÄÎ°ú Î≥ÄÌôò Î∂àÌïÑÏöî)
    if (auction.images) {
      try {
        const images = JSON.parse(auction.images);
        auction.images = images;
        auction.imageUrl = images[0] || null;
      } catch (error) {
        console.error('Ïù¥ÎØ∏ÏßÄ ÌååÏã± Ïò§Î•ò:', error);
        auction.images = [];
        auction.imageUrl = null;
      }
    }
    
    res.json(auction);
  } catch (error) {
    console.error('Get auction error:', error);
    res.status(500).json({ message: 'ÏÑúÎ≤Ñ Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.' });
  }
});

// ÏÉà Í≤ΩÎß§ ÏÉùÏÑ± (Ïù∏Ï¶ù ÌïÑÏöî) - ÏäπÏù∏ ÎåÄÍ∏∞ ÏÉÅÌÉúÎ°ú ÏÉùÏÑ±
router.post('/', auth, async (req: AuthRequest, res) => {
  try {
    const { title, description, startingPrice, duration, category, imageUris } = req.body;
    const db = getDatabase();
    
    // Í≤ΩÎß§ Í∏∞Í∞ÑÏùÑ Î∂Ñ Îã®ÏúÑÎ°ú Î≥ÄÌôò
    let durationMinutes = 1440; // Í∏∞Î≥∏Í∞í: 24ÏãúÍ∞Ñ
    switch (duration) {
      case '1h': durationMinutes = 60; break;
      case '6h': durationMinutes = 360; break;
      case '1d': durationMinutes = 1440; break;
      case '3d': durationMinutes = 4320; break;
    }
    
    const now = new Date();
    const startTime = now.toISOString();
    const endTime = new Date(now.getTime() + durationMinutes * 60 * 1000).toISOString();
    
    // Ïù¥ÎØ∏ÏßÄ URLÏùÑ Í∑∏ÎåÄÎ°ú Ï†ÄÏû• (Ïù¥ÎØ∏ ÏôÑÏ†ÑÌïú URL ÌòïÌÉú)
    const processedImages = imageUris;
    
    const stmt = db.prepare(`
      INSERT INTO auctions (
        title, 
        description, 
        starting_price, 
        current_price, 
        seller_id, 
        category, 
        images, 
        status,
        start_time,
        end_time,
        duration_minutes,
        created_at,
        updated_at
      ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)
    `);
    
    const result = stmt.run(
      title, 
      description, 
      startingPrice, 
      startingPrice, 
      req.user?.userId, 
      category, 
      JSON.stringify(processedImages), // Î≥ÄÌôòÎêú Ïù¥ÎØ∏ÏßÄ URL Ï†ÄÏû•
      'pending', // ÏäπÏù∏ ÎåÄÍ∏∞ ÏÉÅÌÉú
      startTime,
      endTime,
      durationMinutes,
      new Date().toISOString(),
      new Date().toISOString()
    );
    
    const auctionId = result.lastInsertRowid;
    
    // Î°úÍ∑∏ Í∏∞Î°ù
    logAuctionActivity({
      auctionId: Number(auctionId),
      userId: req.user?.userId,
      action: 'created',
      details: {
        title,
        category,
        startingPrice,
        duration,
        status: 'pending'
      },
      ipAddress: req.ip,
      userAgent: req.get('User-Agent')
    });
    
    res.status(201).json({
      message: 'Í≤ΩÎß§Í∞Ä Îì±Î°ùÎêòÏóàÏäµÎãàÎã§. Í¥ÄÎ¶¨Ïûê ÏäπÏù∏ ÌõÑ Í≤åÏãúÎê©ÎãàÎã§.',
      auctionId: auctionId
    });
  } catch (error) {
    console.error('Create auction error:', error);
    res.status(500).json({ message: 'ÏÑúÎ≤Ñ Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.' });
  }
});

// ÏûÖÏ∞∞ (Ïù∏Ï¶ù ÌïÑÏöî)
router.post('/:id/bid', auth, async (req: AuthRequest, res) => {
  try {
    const { amount } = req.body;
    const auctionId = req.params.id;
    const db = getDatabase();
    
    // Í≤ΩÎß§ Ï°∞Ìöå
    const auction = db.prepare('SELECT * FROM auctions WHERE id = ?').get(auctionId) as any;
    if (!auction) {
      return res.status(404).json({ message: 'Í≤ΩÎß§Î•º Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§.' });
    }
    
    if (auction.status !== 'active') {
      return res.status(400).json({ message: 'Ï¢ÖÎ£åÎêú Í≤ΩÎß§ÏûÖÎãàÎã§.' });
    }
    
    // ÏûêÏã†Ïù¥ Îì±Î°ùÌïú Í≤ΩÎß§ÏóêÎäî ÏûÖÏ∞∞Ìï† Ïàò ÏóÜÏùå
    if (auction.seller_id === req.user?.userId) {
      return res.status(400).json({ message: 'ÏûêÏã†Ïù¥ Îì±Î°ùÌïú Í≤ΩÎß§ÏóêÎäî ÏûÖÏ∞∞Ìï† Ïàò ÏóÜÏäµÎãàÎã§.' });
    }
    
    // Í≤ΩÎß§ Ï¢ÖÎ£å ÏãúÍ∞Ñ ÌôïÏù∏ (1Î∂Ñ ÎØ∏Îßå ÎÇ®ÏïòÏúºÎ©¥ ÏûÖÏ∞∞ Î∂àÍ∞Ä)
    if (auction.end_time) {
      const now = new Date();
      const endTime = new Date(auction.end_time);
      const timeLeft = endTime.getTime() - now.getTime();
      const minutesLeft = timeLeft / (1000 * 60);
      
      if (minutesLeft < 1) {
        return res.status(400).json({ message: 'Í≤ΩÎß§ Ï¢ÖÎ£å 1Î∂Ñ Ï†ÑÎ∂ÄÌÑ∞Îäî ÏûÖÏ∞∞Ìï† Ïàò ÏóÜÏäµÎãàÎã§.' });
      }
    }
    
    if (amount <= auction.current_price) {
      return res.status(400).json({ message: 'ÌòÑÏû¨ Í∞ÄÍ≤©Î≥¥Îã§ ÎÜíÏùÄ Í∏àÏï°ÏùÑ ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.' });
    }
    
    // Ìä∏ÎûúÏû≠ÏÖò ÏãúÏûë
    const transaction = db.transaction(() => {
      const now = new Date().toISOString();
      
      // ÏûÖÏ∞∞ ÏÉùÏÑ± (created_at ÏãúÍ∞Ñ Ìè¨Ìï®)
      const bidStmt = db.prepare('INSERT INTO bids (auction_id, bidder_id, amount, created_at) VALUES (?, ?, ?, ?)');
      const bidResult = bidStmt.run(auctionId, req.user?.userId, amount, now);
      
      // Í≤ΩÎß§ ÌòÑÏû¨ Í∞ÄÍ≤© ÏóÖÎç∞Ïù¥Ìä∏
      const updateStmt = db.prepare('UPDATE auctions SET current_price = ? WHERE id = ?');
      updateStmt.run(amount, auctionId);
      
      return { ...bidResult, created_at: now };
    });
    
    const result = transaction();
    
    // Î°úÍ∑∏ Í∏∞Î°ù
    logAuctionActivity({
      auctionId: parseInt(auctionId),
      userId: req.user?.userId,
      action: 'bid_placed',
      details: {
        amount,
        previousPrice: auction.current_price,
        newPrice: amount
      },
      ipAddress: req.ip,
      userAgent: req.get('User-Agent')
    });
    
    // ÏûÖÏ∞∞ ÏÑ±Í≥µ Î°úÍ∑∏ Ï∂îÍ∞Ä
    console.log(`[ÏûÖÏ∞∞ ÏÑ±Í≥µ] Í≤ΩÎß§ ID: ${auctionId}, ÏÇ¨Ïö©Ïûê ID: ${req.user?.userId}, ÏûÖÏ∞∞ Í∏àÏï°: ${amount}, ÌòÑÏû¨Í∞Ä: ${auction.current_price}`);
    
    // ÏûÖÏ∞∞ÏûêÏóêÍ≤å Í∞úÏù∏ÌôîÎêú ÏïåÎ¶º Ï†ÑÏÜ° (ÏûêÏã†Ïù¥ ÏûÖÏ∞∞Ìïú Í≤ÉÎßå)
    const bidderInfo = db.prepare('SELECT username FROM users WHERE id = ?').get(req.user?.userId) as any;
    if (bidderInfo) {
      console.log(`‚úÖ ÏûÖÏ∞∞ ÏïåÎ¶º: ÏÇ¨Ïö©Ïûê ${bidderInfo.username}Ïù¥ Í≤ΩÎß§ ${auctionId}Ïóê ${amount}Ïõê ÏûÖÏ∞∞`);
    }
    
    // ÏûÖÏ∞∞ Ïàò Î∞è Ï∞∏Ïó¨Ïûê Ïàò Ï°∞Ìöå
    const bidCountResult = db.prepare('SELECT COUNT(*) as count FROM bids WHERE auction_id = ?').get(auctionId) as any;
    const participantCountResult = db.prepare('SELECT COUNT(DISTINCT bidder_id) as count FROM bids WHERE auction_id = ?').get(auctionId) as any;
    
    res.json({
      message: 'ÏûÖÏ∞∞Ïù¥ ÏôÑÎ£åÎêòÏóàÏäµÎãàÎã§.',
      bidId: result.lastInsertRowid,
      newCurrentPrice: amount,
      bidCount: bidCountResult.count,
      participantCount: participantCountResult.count,
      lastBidTime: result.created_at
    });
  } catch (error) {
    console.error('Create bid error:', error);
    res.status(500).json({ message: 'ÏÑúÎ≤Ñ Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.' });
  }
});

// Í≤ΩÎß§ Ï¢ÖÎ£å (ÌåêÎß§ÏûêÎßå)
router.patch('/:id/end', auth, async (req: AuthRequest, res) => {
  try {
    const db = getDatabase();
    const auction = db.prepare('SELECT * FROM auctions WHERE id = ?').get(req.params.id) as any;
    
    if (!auction) {
      return res.status(404).json({ message: 'Í≤ΩÎß§Î•º Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§.' });
    }
    
    if (auction.seller_id !== req.user?.userId) {
      return res.status(403).json({ message: 'Í∂åÌïúÏù¥ ÏóÜÏäµÎãàÎã§.' });
    }
    
    const stmt = db.prepare('UPDATE auctions SET status = ? WHERE id = ?');
    stmt.run('ended', req.params.id);
    
    res.json({
      message: 'Í≤ΩÎß§Í∞Ä Ï¢ÖÎ£åÎêòÏóàÏäµÎãàÎã§.'
    });
  } catch (error) {
    console.error('End auction error:', error);
    res.status(500).json({ message: 'ÏÑúÎ≤Ñ Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.' });
  }
});

// Í¥ÄÎ¶¨ÏûêÏö© Í≤ΩÎß§ ÏäπÏù∏/Í±∞Î∂Ä API
router.patch('/:id/approve', auth, async (req: AuthRequest, res) => {
  try {
    const db = getDatabase();
    
    // Í¥ÄÎ¶¨Ïûê Í∂åÌïú ÌôïÏù∏
    const user = db.prepare('SELECT user_type FROM users WHERE id = ?').get(req.user?.userId) as any;
    if (!user || user.user_type !== 'admin') {
      return res.status(403).json({ message: 'Í¥ÄÎ¶¨Ïûê Í∂åÌïúÏù¥ ÌïÑÏöîÌï©ÎãàÎã§.' });
    }
    
    // Í≤ΩÎß§ Ï†ïÎ≥¥ Ï°∞Ìöå (Ïù¥Î©îÏùº Î∞úÏÜ°Ïö©)
    const auctionInfo = db.prepare(`
      SELECT a.title, u.email, u.username, a.seller_id
      FROM auctions a 
      JOIN users u ON a.seller_id = u.id 
      WHERE a.id = ?
    `).get(req.params.id) as any;
    
    const stmt = db.prepare('UPDATE auctions SET status = ? WHERE id = ?');
    stmt.run('active', req.params.id);
    
    // ÏäπÏù∏ ÏïåÎ¶º Ïù¥Î©îÏùº Î∞úÏÜ° (ÌåêÎß§ÏûêÏóêÍ≤åÎßå)
    if (auctionInfo?.email) {
      try {
        await sendApprovalNotificationEmail(
          auctionInfo.email,
          auctionInfo.username,
          auctionInfo.title,
          Number(req.params.id)
        );
        console.log(`‚úÖ Í≤ΩÎß§ ÏäπÏù∏ ÏïåÎ¶º Ïù¥Î©îÏùº Î∞úÏÜ°: ${auctionInfo.email} - ${auctionInfo.title}`);
      } catch (error) {
        console.error('ÏäπÏù∏ ÏïåÎ¶º Ïù¥Î©îÏùº Î∞úÏÜ° Ïã§Ìå®:', error);
      }
    }
    
    res.json({
      message: 'Í≤ΩÎß§Í∞Ä ÏäπÏù∏ÎêòÏóàÏäµÎãàÎã§.'
    });
  } catch (error) {
    console.error('Approve auction error:', error);
    res.status(500).json({ message: 'ÏÑúÎ≤Ñ Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.' });
  }
});

router.patch('/:id/reject', auth, async (req: AuthRequest, res) => {
  try {
    const db = getDatabase();
    
    // Í¥ÄÎ¶¨Ïûê Í∂åÌïú ÌôïÏù∏
    const user = db.prepare('SELECT user_type FROM users WHERE id = ?').get(req.user?.userId) as any;
    if (!user || user.user_type !== 'admin') {
      return res.status(403).json({ message: 'Í¥ÄÎ¶¨Ïûê Í∂åÌïúÏù¥ ÌïÑÏöîÌï©ÎãàÎã§.' });
    }
    
    const stmt = db.prepare('UPDATE auctions SET status = ? WHERE id = ?');
    stmt.run('rejected', req.params.id);
    
    res.json({
      message: 'Í≤ΩÎß§Í∞Ä Í±∞Î∂ÄÎêòÏóàÏäµÎãàÎã§.'
    });
  } catch (error) {
    console.error('Reject auction error:', error);
    res.status(500).json({ message: 'ÏÑúÎ≤Ñ Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.' });
  }
});

// Í¥ÄÎ¶¨ÏûêÏö© Í≤ΩÎß§ Í±∞Î∂Ä API (POST Î©îÏÑúÎìú Ìò∏Ìôò)
router.post('/:id/reject', auth, async (req: AuthRequest, res) => {
  try {
    const db = getDatabase();
    
    // Í¥ÄÎ¶¨Ïûê Í∂åÌïú ÌôïÏù∏
    const user = db.prepare('SELECT user_type FROM users WHERE id = ?').get(req.user?.userId) as any;
    if (!user || user.user_type !== 'admin') {
      return res.status(403).json({ message: 'Í¥ÄÎ¶¨Ïûê Í∂åÌïúÏù¥ ÌïÑÏöîÌï©ÎãàÎã§.' });
    }
    
    const stmt = db.prepare('UPDATE auctions SET status = ? WHERE id = ?');
    stmt.run('rejected', req.params.id);
    
    res.json({
      message: 'Í≤ΩÎß§Í∞Ä Í±∞Î∂ÄÎêòÏóàÏäµÎãàÎã§.'
    });
  } catch (error) {
    console.error('Reject auction (POST) error:', error);
    res.status(500).json({ message: 'ÏÑúÎ≤Ñ Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.' });
  }
});

// Í¥ÄÎ¶¨ÏûêÏö© Í≤ΩÎß§ Ï¢ÖÎ£å API
router.post('/:id/end', auth, async (req: AuthRequest, res) => {
  try {
    const db = getDatabase();
    
    // Í¥ÄÎ¶¨Ïûê Í∂åÌïú ÌôïÏù∏
    const user = db.prepare('SELECT user_type FROM users WHERE id = ?').get(req.user?.userId) as any;
    if (!user || user.user_type !== 'admin') {
      return res.status(403).json({ message: 'Í¥ÄÎ¶¨Ïûê Í∂åÌïúÏù¥ ÌïÑÏöîÌï©ÎãàÎã§.' });
    }
    
    const auction = db.prepare('SELECT * FROM auctions WHERE id = ?').get(req.params.id) as any;
    
    if (!auction) {
      return res.status(404).json({ message: 'Í≤ΩÎß§Î•º Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§.' });
    }
    
    const stmt = db.prepare('UPDATE auctions SET status = ? WHERE id = ?');
    stmt.run('ended', req.params.id);
    
    // ÎÇôÏ∞∞ÏûêÏôÄ ÌåêÎß§Ïûê Ï†ïÎ≥¥ Ï°∞Ìöå
    const sellerInfo = db.prepare(`
      SELECT u.email, u.username 
      FROM users u 
      WHERE u.id = ?
    `).get(auction.seller_id) as any;
    
    // ÎÇôÏ∞∞Ïûê Ï†ïÎ≥¥ Ï°∞Ìöå Î∞è Ïù¥Î©îÏùº Î∞úÏÜ° (ÏûÖÏ∞∞Ïù¥ ÏûàÏóàÏùÑ ÎïåÎßå)
    if (auction.current_price > auction.starting_price) {
      try {
        const winnerInfo = db.prepare(`
          SELECT u.email, u.username 
          FROM users u 
          JOIN bids b ON u.id = b.bidder_id 
          WHERE b.auction_id = ? AND b.amount = ? 
          ORDER BY b.created_at DESC 
          LIMIT 1
        `).get(req.params.id, auction.current_price) as any;
        
        // ÎÇôÏ∞∞ÏûêÏóêÍ≤å ÎÇôÏ∞∞ ÏïåÎ¶º
        if (winnerInfo?.email) {
          await sendWinNotificationEmail(
            winnerInfo.email,
            winnerInfo.username,
            auction.title,
            auction.current_price,
            parseInt(req.params.id)
          );
          console.log(`‚úÖ ÎÇôÏ∞∞ ÏïåÎ¶º Ïù¥Î©îÏùº Î∞úÏÜ°: ${winnerInfo.email} - ${auction.title}`);
        }
        
        // ÌåêÎß§ÏûêÏóêÍ≤å Í≤ΩÎß§ Ï¢ÖÎ£å ÏïåÎ¶º
        if (sellerInfo?.email) {
          await sendApprovalNotificationEmail(
            sellerInfo.email,
            sellerInfo.username,
            `${auction.title} Í≤ΩÎß§Í∞Ä Ï¢ÖÎ£åÎêòÏóàÏäµÎãàÎã§. ÎÇôÏ∞∞Í∞Ä: ${auction.current_price.toLocaleString()}Ïõê`,
            parseInt(req.params.id)
          );
          console.log(`‚úÖ Í≤ΩÎß§ Ï¢ÖÎ£å ÏïåÎ¶º Ïù¥Î©îÏùº Î∞úÏÜ°: ${sellerInfo.email} - ${auction.title}`);
        }
      } catch (error) {
        console.error('Í≤ΩÎß§ Ï¢ÖÎ£å ÏïåÎ¶º Ïù¥Î©îÏùº Î∞úÏÜ° Ïã§Ìå®:', error);
      }
    } else {
      // ÏûÖÏ∞∞Ïù¥ ÏóÜÏóàÏùÑ ÎïåÎäî ÌåêÎß§ÏûêÏóêÍ≤åÎßå ÏïåÎ¶º
      if (sellerInfo?.email) {
        try {
          await sendApprovalNotificationEmail(
            sellerInfo.email,
            sellerInfo.username,
            `${auction.title} Í≤ΩÎß§Í∞Ä Ï¢ÖÎ£åÎêòÏóàÏäµÎãàÎã§. (ÏûÖÏ∞∞ ÏóÜÏùå)`,
            parseInt(req.params.id)
          );
          console.log(`‚úÖ Í≤ΩÎß§ Ï¢ÖÎ£å ÏïåÎ¶º Ïù¥Î©îÏùº Î∞úÏÜ°: ${sellerInfo.email} - ${auction.title} (ÏûÖÏ∞∞ ÏóÜÏùå)`);
        } catch (error) {
          console.error('Í≤ΩÎß§ Ï¢ÖÎ£å ÏïåÎ¶º Ïù¥Î©îÏùº Î∞úÏÜ° Ïã§Ìå®:', error);
        }
      }
    }
    
    // Î°úÍ∑∏ Í∏∞Î°ù
    logAuctionActivity({
      auctionId: parseInt(req.params.id),
      userId: req.user?.userId,
      action: 'ended',
      details: {
        finalPrice: auction.current_price,
        reason: 'admin_manual_end'
      },
      ipAddress: req.ip,
      userAgent: req.get('User-Agent')
    });
    
    res.json({
      message: 'Í≤ΩÎß§Í∞Ä Ï¢ÖÎ£åÎêòÏóàÏäµÎãàÎã§.'
    });
  } catch (error) {
    console.error('Admin end auction error:', error);
    res.status(500).json({ message: 'ÏÑúÎ≤Ñ Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.' });
  }
});

// Í¥ÄÎ¶¨ÏûêÏö© Í≤ΩÎß§ Ï†ïÎ≥¥ ÏàòÏ†ï API
router.put('/:id', auth, async (req: AuthRequest, res) => {
  try {
    const db = getDatabase();
    
    // Í¥ÄÎ¶¨Ïûê Í∂åÌïú ÌôïÏù∏
    const user = db.prepare('SELECT user_type FROM users WHERE id = ?').get(req.user?.userId) as any;
    if (!user || user.user_type !== 'admin') {
      return res.status(403).json({ message: 'Í¥ÄÎ¶¨Ïûê Í∂åÌïúÏù¥ ÌïÑÏöîÌï©ÎãàÎã§.' });
    }
    
    const { title, description, startingPrice, currentPrice, category, status, autoEndEnabled, autoEndMinutes } = req.body;
    
    const auction = db.prepare('SELECT * FROM auctions WHERE id = ?').get(req.params.id) as any;
    if (!auction) {
      return res.status(404).json({ message: 'Í≤ΩÎß§Î•º Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§.' });
    }
    
    // ÏóÖÎç∞Ïù¥Ìä∏Ìï† ÌïÑÎìúÎì§
    const updateFields = [];
    const updateValues = [];
    
    if (title !== undefined) {
      updateFields.push('title = ?');
      updateValues.push(title);
    }
    if (description !== undefined) {
      updateFields.push('description = ?');
      updateValues.push(description);
    }
    if (startingPrice !== undefined) {
      updateFields.push('starting_price = ?');
      updateValues.push(startingPrice);
    }
    if (currentPrice !== undefined) {
      updateFields.push('current_price = ?');
      updateValues.push(currentPrice);
    }
    if (category !== undefined) {
      updateFields.push('category = ?');
      updateValues.push(category);
    }
    if (status !== undefined) {
      updateFields.push('status = ?');
      updateValues.push(status);
    }
    if (autoEndEnabled !== undefined) {
      updateFields.push('auto_end_enabled = ?');
      updateValues.push(autoEndEnabled);
    }
    if (autoEndMinutes !== undefined) {
      updateFields.push('auto_end_minutes = ?');
      updateValues.push(autoEndMinutes);
    }
    
    if (updateFields.length === 0) {
      return res.status(400).json({ message: 'ÏàòÏ†ïÌï† ÌïÑÎìúÎ•º ÏßÄÏ†ïÌï¥Ï£ºÏÑ∏Ïöî.' });
    }
    
    updateFields.push('updated_at = ?');
    updateValues.push(new Date().toISOString());
    updateValues.push(req.params.id);
    
    const stmt = db.prepare(`UPDATE auctions SET ${updateFields.join(', ')} WHERE id = ?`);
    stmt.run(...updateValues);
    
    res.json({
      message: 'Í≤ΩÎß§ Ï†ïÎ≥¥Í∞Ä ÏàòÏ†ïÎêòÏóàÏäµÎãàÎã§.'
    });
  } catch (error) {
    console.error('Update auction error:', error);
    res.status(500).json({ message: 'ÏÑúÎ≤Ñ Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.' });
  }
});

// Í¥ÄÎ¶¨ÏûêÏö© Í≤ΩÎß§ ÏßÄÏó∞ Ï¢ÖÎ£å API
router.post('/:id/delay-end', auth, async (req: AuthRequest, res) => {
  try {
    const db = getDatabase();
    
    // Í¥ÄÎ¶¨Ïûê Í∂åÌïú ÌôïÏù∏
    const user = db.prepare('SELECT user_type FROM users WHERE id = ?').get(req.user?.userId) as any;
    if (!user || user.user_type !== 'admin') {
      return res.status(403).json({ message: 'Í¥ÄÎ¶¨Ïûê Í∂åÌïúÏù¥ ÌïÑÏöîÌï©ÎãàÎã§.' });
    }
    
    const { minutes } = req.body;
    if (!minutes || minutes < 1) {
      return res.status(400).json({ message: 'Ïú†Ìö®Ìïú ÏãúÍ∞ÑÏùÑ ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.' });
    }
    
    const auction = db.prepare('SELECT * FROM auctions WHERE id = ?').get(req.params.id) as any;
    if (!auction) {
      return res.status(404).json({ message: 'Í≤ΩÎß§Î•º Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§.' });
    }
    
    if (auction.status !== 'active') {
      return res.status(400).json({ message: 'ÌôúÏÑ± ÏÉÅÌÉúÏùò Í≤ΩÎß§Îßå ÏßÄÏó∞ Ï¢ÖÎ£åÌï† Ïàò ÏûàÏäµÎãàÎã§.' });
    }
    
    // ÌòÑÏû¨ ÏãúÍ∞ÑÏóêÏÑú ÏßÄÏ†ïÎêú Î∂ÑÎßåÌÅº Ï∂îÍ∞Ä
    const newEndTime = new Date(Date.now() + minutes * 60 * 1000);
    
    const stmt = db.prepare('UPDATE auctions SET end_time = ?, auto_end_enabled = 1, auto_end_minutes = ? WHERE id = ?');
    stmt.run(newEndTime.toISOString(), minutes, req.params.id);
    
    // Î°úÍ∑∏ Í∏∞Î°ù
    logAuctionActivity({
      auctionId: parseInt(req.params.id),
      userId: req.user?.userId,
      action: 'delayed_end',
      details: {
        delayMinutes: minutes,
        originalEndTime: auction.end_time,
        newEndTime: newEndTime.toISOString()
      },
      ipAddress: req.ip,
      userAgent: req.get('User-Agent')
    });
    
    res.json({
      message: `${minutes}Î∂Ñ ÌõÑÏóê Í≤ΩÎß§Í∞Ä Ï¢ÖÎ£åÎê©ÎãàÎã§.`,
      newEndTime: newEndTime.toISOString()
    });
  } catch (error) {
    console.error('Delay end auction error:', error);
    res.status(500).json({ message: 'ÏÑúÎ≤Ñ Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.' });
  }
});

// Í≤ΩÎß§ ÏäπÏù∏ Ïãú Ï¢ÖÎ£å ÏãúÍ∞Ñ ÏÑ§Ï†ï API
router.post('/:id/approve', auth, async (req: AuthRequest, res) => {
  try {
    const db = getDatabase();
    
    // Í¥ÄÎ¶¨Ïûê Í∂åÌïú ÌôïÏù∏
    const user = db.prepare('SELECT user_type FROM users WHERE id = ?').get(req.user?.userId) as any;
    if (!user || user.user_type !== 'admin') {
      return res.status(403).json({ message: 'Í¥ÄÎ¶¨Ïûê Í∂åÌïúÏù¥ ÌïÑÏöîÌï©ÎãàÎã§.' });
    }
    
    const auction = db.prepare('SELECT * FROM auctions WHERE id = ?').get(req.params.id) as any;
    if (!auction) {
      return res.status(404).json({ message: 'Í≤ΩÎß§Î•º Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§.' });
    }
    
    if (auction.status !== 'pending') {
      return res.status(400).json({ message: 'ÏäπÏù∏ ÎåÄÍ∏∞ ÏÉÅÌÉúÏùò Í≤ΩÎß§Îßå ÏäπÏù∏Ìï† Ïàò ÏûàÏäµÎãàÎã§.' });
    }
    
    // ÌòÑÏû¨ ÏãúÍ∞ÑÏóêÏÑú duration_minutesÎßåÌÅº Ï∂îÍ∞ÄÌïòÏó¨ Ï¢ÖÎ£å ÏãúÍ∞Ñ Í≥ÑÏÇ∞
    const now = new Date();
    const endTime = new Date(now.getTime() + auction.duration_minutes * 60 * 1000);
    
    const stmt = db.prepare(`
      UPDATE auctions 
      SET status = 'active', 
          start_time = ?, 
          end_time = ?, 
          updated_at = ? 
      WHERE id = ?
    `);
    stmt.run(now.toISOString(), endTime.toISOString(), now.toISOString(), req.params.id);
    
    // Î°úÍ∑∏ Í∏∞Î°ù
    logAuctionActivity({
      auctionId: parseInt(req.params.id),
      userId: req.user?.userId,
      action: 'approved',
      details: {
        startTime: now.toISOString(),
        endTime: endTime.toISOString(),
        duration: auction.duration_minutes
      },
      ipAddress: req.ip,
      userAgent: req.get('User-Agent')
    });
    
    res.json({
      message: 'Í≤ΩÎß§Í∞Ä ÏäπÏù∏ÎêòÏóàÏäµÎãàÎã§.',
      startTime: now.toISOString(),
      endTime: endTime.toISOString()
    });
  } catch (error) {
    console.error('Approve auction error:', error);
    res.status(500).json({ message: 'ÏÑúÎ≤Ñ Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.' });
  }
});

// Í¥ÄÎ¶¨ÏûêÏö© ÏäπÏù∏ ÎåÄÍ∏∞ Í≤ΩÎß§ Î™©Î°ù Ï°∞Ìöå
router.get('/admin/pending', auth, async (req: AuthRequest, res) => {
  try {
    const db = getDatabase();
    
    // Í¥ÄÎ¶¨Ïûê Í∂åÌïú ÌôïÏù∏
    const user = db.prepare('SELECT user_type FROM users WHERE id = ?').get(req.user?.userId) as any;
    if (!user || user.user_type !== 'admin') {
      return res.status(403).json({ message: 'Í¥ÄÎ¶¨Ïûê Í∂åÌïúÏù¥ ÌïÑÏöîÌï©ÎãàÎã§.' });
    }
    
    const auctions = db.prepare(`
      SELECT 
        a.id,
        a.title,
        a.description,
        a.starting_price as startingPrice,
        a.category,
        a.images as imageUris,
        a.created_at as createdAt,
        u.username as sellerName,
        u.email as sellerEmail
      FROM auctions a
        JOIN users u ON a.seller_id = u.id
      WHERE a.status = 'pending'
      ORDER BY a.created_at DESC
    `).all();
    
    res.json(auctions);
  } catch (error) {
    console.error('Get pending auctions error:', error);
    res.status(500).json({ message: 'ÏÑúÎ≤Ñ Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.' });
  }
});

// Í¥ÄÎ¶¨ÏûêÏö© Í≤ΩÎß§ Î™©Î°ù Ï°∞Ìöå API (Î™®Îì† ÏÉÅÌÉúÏùò Í≤ΩÎß§)
router.get('/admin/all', auth, async (req: AuthRequest, res) => {
  try {
    const db = getDatabase();
    
    // Í¥ÄÎ¶¨Ïûê Í∂åÌïú ÌôïÏù∏
    const user = db.prepare('SELECT user_type FROM users WHERE id = ?').get(req.user?.userId) as any;
    if (!user || user.user_type !== 'admin') {
      return res.status(403).json({ message: 'Í¥ÄÎ¶¨Ïûê Í∂åÌïúÏù¥ ÌïÑÏöîÌï©ÎãàÎã§.' });
    }
    
    const auctions = db.prepare(`
      SELECT 
        a.id,
        a.title,
        a.description,
        a.starting_price as startingPrice,
        a.current_price as currentPrice,
        a.end_time as endTime,
        a.status,
        a.created_at as createdAt,
        a.category,
        a.images,
        u.username as sellerName
      FROM auctions a
      LEFT JOIN users u ON a.seller_id = u.id
      ORDER BY a.created_at DESC
    `).all();
    
    // ÏùëÎãµ Îç∞Ïù¥ÌÑ∞ ÌòïÏãù ÎßûÏ∂îÍ∏∞
    const formattedAuctions = auctions.map((auction: any) => ({
      id: auction.id,
      title: auction.title,
      description: auction.description,
      startingPrice: auction.startingPrice,
      currentPrice: auction.currentPrice,
      endTime: auction.endTime,
      status: auction.status,
      createdAt: auction.createdAt,
      category: auction.category,
      images: auction.images ? JSON.parse(auction.images) : [],
      imageUrl: auction.images ? JSON.parse(auction.images)[0] : null,
      seller: {
        username: auction.sellerName
      }
    }));
    
    res.json(formattedAuctions);
  } catch (error) {
    console.error('Get all auctions error:', error);
    res.status(500).json({ message: 'Í≤ΩÎß§ Î™©Î°ùÏùÑ Î∂àÎü¨Ïò¨ Ïàò ÏóÜÏäµÎãàÎã§.' });
  }
});

// Í≤ΩÎß§ Î°úÍ∑∏ Ï°∞Ìöå API (Í¥ÄÎ¶¨Ïûê Ï†ÑÏö©) - ÌäπÏ†ï Í≤ΩÎß§ ID Ï°∞ÌöåÎ≥¥Îã§ Î®ºÏ†Ä Ï†ïÏùò
router.get('/admin/logs', auth, async (req: AuthRequest, res) => {
  try {
    const db = getDatabase();
    
    // Í¥ÄÎ¶¨Ïûê Í∂åÌïú ÌôïÏù∏
    const user = db.prepare('SELECT user_type FROM users WHERE id = ?').get(req.user?.userId) as any;
    if (!user || user.user_type !== 'admin') {
      return res.status(403).json({ message: 'Í¥ÄÎ¶¨Ïûê Í∂åÌïúÏù¥ ÌïÑÏöîÌï©ÎãàÎã§.' });
    }
    
    const { auctionId, limit = 100 } = req.query;
    
    // Î°úÍ∑∏ Ï°∞Ìöå ÏøºÎ¶¨ ÏàòÏ†ï
    let query = `
      SELECT al.*, u.username, a.title as auction_title
      FROM auction_logs al
      LEFT JOIN users u ON al.user_id = u.id
      LEFT JOIN auctions a ON al.auction_id = a.id
    `;
    
    const params: any[] = [];
    if (auctionId) {
      query += ' WHERE al.auction_id = ?';
      params.push(parseInt(auctionId as string));
    }
    
    query += ' ORDER BY al.timestamp DESC LIMIT ?';
    params.push(parseInt(limit as string));
    
    const logs = db.prepare(query).all(...params);
    
    res.json({
      logs,
      total: logs.length
    });
  } catch (error) {
    console.error('Get logs error:', error);
    res.status(500).json({ message: 'ÏÑúÎ≤Ñ Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.' });
  }
});

// Ìï´Ìïú Í≤ΩÎß§ ÏÑ§Ï†ï/Ìï¥Ï†ú
router.post('/:id/set-hot', auth, async (req: AuthRequest, res) => {
  try {
    const db = getDatabase();
    
    // Í¥ÄÎ¶¨Ïûê Í∂åÌïú ÌôïÏù∏
    const user = db.prepare('SELECT user_type FROM users WHERE id = ?').get(req.user?.userId) as any;
    if (!user || user.user_type !== 'admin') {
      return res.status(403).json({ message: 'Í¥ÄÎ¶¨Ïûê Í∂åÌïúÏù¥ ÌïÑÏöîÌï©ÎãàÎã§.' });
    }
    
    const auctionId = req.params.id;
    const { isHot } = req.body;
    
    // Í≤ΩÎß§ Ï°¥Ïû¨ ÌôïÏù∏
    const auction = db.prepare('SELECT * FROM auctions WHERE id = ?').get(auctionId) as any;
    if (!auction) {
      return res.status(404).json({ message: 'Í≤ΩÎß§Î•º Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§.' });
    }
    
    // Ìï´Ìïú Í≤ΩÎß§Îäî ÏµúÎåÄ 1Í∞úÎßå ÌóàÏö©
    if (isHot) {
      // Í∏∞Ï°¥ Ìï´Ìïú Í≤ΩÎß§ Ìï¥Ï†ú
      db.prepare('UPDATE auctions SET is_hot = 0 WHERE is_hot = 1').run();
    }
    
    // Ìï´Ìïú Í≤ΩÎß§ ÏÑ§Ï†ï/Ìï¥Ï†ú
    db.prepare('UPDATE auctions SET is_hot = ? WHERE id = ?').run(isHot ? 1 : 0, auctionId);
    
    // Ìï´Ìïú Í≤ΩÎß§Î°ú ÏÑ§Ï†ïÎêú Í≤ΩÏö∞ ÌåêÎß§ÏûêÏóêÍ≤å Ïù¥Î©îÏùº Î∞úÏÜ°
    if (isHot) {
      try {
        const sellerInfo = db.prepare(`
          SELECT u.email, u.username 
          FROM users u 
          WHERE u.id = ?
        `).get(auction.seller_id) as any;
        
        if (sellerInfo?.email) {
          await sendHotAuctionNotificationEmail(
            sellerInfo.email,
            sellerInfo.username,
            auction.title,
            parseInt(auctionId)
          );
        }
      } catch (error) {
        console.error('Ìï´Ìïú Í≤ΩÎß§ ÏïåÎ¶º Ïù¥Î©îÏùº Î∞úÏÜ° Ïã§Ìå®:', error);
      }
    }
    
    // Î°úÍ∑∏ Í∏∞Î°ù
    logAuctionActivity({
      auctionId: parseInt(auctionId),
      userId: req.user?.userId,
      action: isHot ? 'set_hot' : 'unset_hot',
      details: {
        auctionTitle: auction.title,
        isHot: isHot
      },
      ipAddress: req.ip,
      userAgent: req.get('User-Agent')
    });
    
    res.json({
      message: isHot ? 'Ìï´Ìïú Í≤ΩÎß§Î°ú ÏÑ§Ï†ïÎêòÏóàÏäµÎãàÎã§.' : 'Ìï´Ìïú Í≤ΩÎß§ ÏÑ§Ï†ïÏù¥ Ìï¥Ï†úÎêòÏóàÏäµÎãàÎã§.'
    });
  } catch (error) {
    console.error('Set hot auction error:', error);
    res.status(500).json({ message: 'ÏÑúÎ≤Ñ Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.' });
  }
});

// Ïù¥Î©îÏùº ÌÖåÏä§Ìä∏ ÏóîÎìúÌè¨Ïù∏Ìä∏ (Í∞úÎ∞úÏö©)
router.post('/test-email', auth, async (req: AuthRequest, res) => {
  try {
    const db = getDatabase();
    
    // Í¥ÄÎ¶¨Ïûê Í∂åÌïú ÌôïÏù∏
    const user = db.prepare('SELECT user_type FROM users WHERE id = ?').get(req.user?.userId) as any;
    if (!user || user.user_type !== 'admin') {
      return res.status(403).json({ message: 'Í¥ÄÎ¶¨Ïûê Í∂åÌïúÏù¥ ÌïÑÏöîÌï©ÎãàÎã§.' });
    }
    
    const { email, type } = req.body;
    
    if (!email) {
      return res.status(400).json({ message: 'Ïù¥Î©îÏùº Ï£ºÏÜåÍ∞Ä ÌïÑÏöîÌï©ÎãàÎã§.' });
    }
    
    let result = false;
    
    switch (type) {
      case 'win':
        result = await sendWinNotificationEmail(
          email,
          'ÌÖåÏä§Ìä∏ ÏÇ¨Ïö©Ïûê',
          'ÌÖåÏä§Ìä∏ Í≤ΩÎß§ ÏÉÅÌíà',
          1000000,
          1
        );
        break;
      case 'approval':
        result = await sendApprovalNotificationEmail(
          email,
          'ÌÖåÏä§Ìä∏ ÏÇ¨Ïö©Ïûê',
          'ÌÖåÏä§Ìä∏ Í≤ΩÎß§ ÏÉÅÌíà',
          1
        );
        break;
      case 'hot':
        result = await sendHotAuctionNotificationEmail(
          email,
          'ÌÖåÏä§Ìä∏ ÏÇ¨Ïö©Ïûê',
          'ÌÖåÏä§Ìä∏ Í≤ΩÎß§ ÏÉÅÌíà',
          1
        );
        break;
      default:
        return res.status(400).json({ message: 'Ïú†Ìö®Ìïú Ïù¥Î©îÏùº ÌÉÄÏûÖÏù¥ ÏïÑÎãôÎãàÎã§. (win, approval, hot)' });
    }
    
    if (result) {
      res.json({ message: 'ÌÖåÏä§Ìä∏ Ïù¥Î©îÏùºÏù¥ ÏÑ±Í≥µÏ†ÅÏúºÎ°ú Î∞úÏÜ°ÎêòÏóàÏäµÎãàÎã§.' });
    } else {
      res.status(500).json({ message: 'Ïù¥Î©îÏùº Î∞úÏÜ°Ïóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.' });
    }
  } catch (error) {
    console.error('Test email error:', error);
    res.status(500).json({ message: 'ÏÑúÎ≤Ñ Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.' });
  }
});

// ÏÇ¨Ïö©ÏûêÎ≥Ñ ÌåêÎß§ Ï§ëÏù∏ Í≤ΩÎß§ Ï°∞Ìöå
router.get('/selling', auth, async (req: AuthRequest, res) => {
  try {
    const db = getDatabase();
    const userId = req.user?.userId;

    if (!userId) {
      return res.status(401).json({ error: 'Ïù∏Ï¶ùÎêòÏßÄ ÏïäÏùÄ ÏÇ¨Ïö©ÏûêÏûÖÎãàÎã§.' });
    }

    const auctions = db.prepare(`
      SELECT a.*, u.username as seller_name,
             COUNT(b.id) as bid_count,
             COUNT(DISTINCT b.bidder_id) as participant_count
      FROM auctions a
      LEFT JOIN users u ON a.seller_id = u.id
      LEFT JOIN bids b ON a.id = b.auction_id
      WHERE a.seller_id = ? AND a.status = 'active'
      GROUP BY a.id
      ORDER BY a.created_at DESC
    `).all(userId) as any[];

    // Ïù¥ÎØ∏ÏßÄ URL Ï≤òÎ¶¨
    const processedAuctions = auctions.map(auction => ({
      ...auction,
      images: auction.images ? JSON.parse(auction.images) : [],
      imageUrl: auction.images ? JSON.parse(auction.images)[0] : null,
      seller: {
        username: auction.seller_name
      },
      bidCount: auction.bid_count || 0,
      participantCount: auction.participant_count || 0
    }));

    res.json(processedAuctions);
  } catch (error) {
    console.error('Failed to get selling auctions:', error);
    res.status(500).json({ error: 'ÌåêÎß§ Ï§ëÏù∏ Í≤ΩÎß§Î•º Í∞ÄÏ†∏Ïò§ÎäîÎç∞ Ïã§Ìå®ÌñàÏäµÎãàÎã§.' });
  }
});

// ÏÇ¨Ïö©ÏûêÎ≥Ñ ÏûÖÏ∞∞Ìïú Í≤ΩÎß§ Ï°∞Ìöå
router.get('/bidding', auth, async (req: AuthRequest, res) => {
  try {
    const db = getDatabase();
    const userId = req.user?.userId;

    if (!userId) {
      return res.status(401).json({ error: 'Ïù∏Ï¶ùÎêòÏßÄ ÏïäÏùÄ ÏÇ¨Ïö©ÏûêÏûÖÎãàÎã§.' });
    }

    const auctions = db.prepare(`
      SELECT DISTINCT a.*, u.username as seller_name,
             COUNT(b.id) as bid_count,
             COUNT(DISTINCT b.bidder_id) as participant_count
      FROM auctions a
      LEFT JOIN users u ON a.seller_id = u.id
      LEFT JOIN bids b ON a.id = b.auction_id
      WHERE b.bidder_id = ? AND a.status = 'active'
      GROUP BY a.id
      ORDER BY a.created_at DESC
    `).all(userId) as any[];

    // Ïù¥ÎØ∏ÏßÄ URL Ï≤òÎ¶¨
    const processedAuctions = auctions.map(auction => ({
      ...auction,
      images: auction.images ? JSON.parse(auction.images) : [],
      imageUrl: auction.images ? JSON.parse(auction.images)[0] : null,
      seller: {
        username: auction.seller_name
      },
      bidCount: auction.bid_count || 0,
      participantCount: auction.participant_count || 0
    }));

    res.json(processedAuctions);
  } catch (error) {
    console.error('Failed to get bidding auctions:', error);
    res.status(500).json({ error: 'ÏûÖÏ∞∞Ìïú Í≤ΩÎß§Î•º Í∞ÄÏ†∏Ïò§ÎäîÎç∞ Ïã§Ìå®ÌñàÏäµÎãàÎã§.' });
  }
});

export default router;
